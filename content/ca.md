# 第三章：HyperLedger证书认证服务

本章的内容的构建来自“主”分支

Hyperledger fabric CA是Hyperledger fabric的认证中心（CA）。

它提供了以下功能：

* 注册身份，或者连接到LDAP作为用户注册表
* 发放登记证书（ECerts）
* 证书更新和撤销

Hyperledger fabric CA由服务器和客户端组件组成。

如果您兴趣参与Hyperledger Fabric CA的开发人员，请参阅Fabric CA存储库以获取更多信息。

## 第一节.概述

下图说明了Hyperledger Fabric CA服务器如何适用于整体Hyperledger Fabric架构。

图片1： 
    ![图片1](https://github.com/guoshijiang/Hyperledger_fabric_v1.0/blob/master/img/1.png "图片1")

有两种与Hyperledger Fabric CA服务器进行交互的方式：通过Hyperledger Fabric CA客户端或通过某个Fabric SDK进行交互。 与Hyperledger Fabric CA服务器的所有通信均通过REST API提供。 有关这些REST API的swagger文档，请参阅fabric-ca/swagger/swagger-fabric-ca.json。

Hyperledger Fabric CA客户端或SDK可能连接到Hyperledger Fabric CA服务器群集中的服务器。 这在图的右上部分中说明。 客户端路由到HA代理端点，该端点将流量负载平衡到fabric-ca-server集群成员之一。

群集中的所有Hyperledger Fabric CA服务器都共享相同的数据库以跟踪身份和证书。 如果配置了LDAP，则身份信息将保存在LDAP中而不是数据库中。

一台服务器可能包含多个CA。 每个CA都是根CA或中间CA. 每个中间CA都有一个父CA，它是根CA或另一个中间CA.

## 第二节.Hyperledger fabric CA入门

### 一.使用的必要条件

* 安装go 1.9+ 
* 设置正确的GOPATH环境变量
* 安装libtool和libtdhl-dev软件包

以下内容是在Ubuntu上安装libtool依赖项：

    sudo apt install libtool libltdl-dev

以下内容是在MacOSX上安装libtool依赖项：

    brew install libtool

注意：如果您通过Homebrew安装libtool，则libtldl-dev在MacOSX上不是必需的

有关libtool的更多信息，请点击：https://www.gnu.org/software/libtool。

有关libltdl-dev的更多信息，请点击：https://www.gnu.org/software/libtool/manual/html_node/Using-libltdl.html。

### 二.安装

以下安装将会在$GOPATH/bin中安装fabric-ca-server和fabric-ca-client的二进制文件。

    go get -u github.com/hyperledger/fabric-ca/cmd/...

注意：如果你已经克隆了fabric-ca代码，请在运行上面的“go get”命令之前确保您位于master分支上。 否则，您可能会看到以下错误：

        <gopath>/src/github.com/hyperledger/fabric-ca; git pull --ff-only
        There is no tracking information for the current branch.
        Please specify which branch you want to merge with.
        See git-pull(1) for details.

            git pull <remote> <branch>

        If you wish to set tracking information for this branch you can do so with:

            git branch --set-upstream-to=<remote>/<branch> tlsdoc

        package github.com/hyperledger/fabric-ca/cmd/fabric-ca-client: exit status 1

### 三.本地启动服务器

以下命令以默认设置启动fabric-ca-server。

    fabric-ca-server start -b admin:adminpw

-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。

一个名为fabric-ca-server-config.yaml的默认配置文件将在可以自定义的本地目录中创建。

### 四.通过Docker启动服务

#### 1.Docker Hub

点击这个链接：https://hub.docker.com/r/hyperledger/fabric-ca/tags/ 

找到与您想要提取的fabric-ca的体系结构和版本相匹配的标签。

到这个目录下：$GOPATH/src/github.com/hyperledger/fabric-ca/docker/server并在编辑器中打开docker-compose.yml。

更改镜像行以反映您之前找到的标签。 该文件对于Beta版本的x86体系结构也是这样的。

    fabric-ca-server:
      image: hyperledger/fabric-ca:x86_64-1.0.0-beta
      container_name: fabric-ca-server
      ports:
        - "7054:7054"
      environment:
        - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      volumes:
        - "./fabric-ca-server:/etc/hyperledger/fabric-ca-server"
      command: sh -c 'fabric-ca-server start -b admin:adminpw'

在与docker-compose.yml文件相同的目录中打开终端并执行以下命令：

    # docker-compose up -d

如果尚未存在，则会将组合文件中指定的fabric-ca镜像下拉，然后启动fabric-ca服务器的实例。

#### 2.构建你自己的Docker镜像

您可以通过docker-compose构建并启动服务器，如下所示。

    cd $GOPATH/src/github.com/hyperledger/fabric-ca
    make docker
    cd docker/server
    docker-compose up -d
    
hyperled/fabric-ca docker镜像包含fabric-ca-server和fabric-ca-client。

    # cd $GOPATH/src/github.com/hyperledger/fabric-ca
    # FABRIC_CA_DYNAMIC_LINK=true make docker
    # cd docker/server
    # docker-compose up -d
    
### 五.探索Fabric CA CLI

本节仅为方便起见提供Fabric CA服务器和客户端的使用消息。以下部分提供了其他使用信息。

#### 1.服务器命令行

    Hyperledger Fabric Certificate Authority Server

    Usage:
      fabric-ca-server [command]

    Available Commands:
      init        Initialize the fabric-ca server
      start       Start the fabric-ca server
      version     Prints Fabric CA Server version

    Flags:
          --address string                            Listening address of fabric-ca-server (default "0.0.0.0")
      -b, --boot string                               The user:pass for bootstrap admin which is required to build default config file
          --ca.certfile string                        PEM-encoded CA certificate file (default "ca-cert.pem")
          --ca.chainfile string                       PEM-encoded CA chain file (default "ca-chain.pem")
          --ca.keyfile string                         PEM-encoded CA key file
      -n, --ca.name string                            Certificate Authority name
          --cacount int                               Number of non-default CA instances
          --cafiles stringSlice                       A list of comma-separated CA configuration files
          --cfg.affiliations.allowremove              Enables removal of affiliations dynamically
          --cfg.identities.allowremove                Enables removal of identities dynamically
          --crl.expiry duration                       Expiration for the CRL generated by the gencrl request (default 24h0m0s)
          --crlsizelimit int                          Size limit of an acceptable CRL in bytes (default 512000)
          --csr.cn string                             The common name field of the certificate signing request to a parent fabric-ca-server
          --csr.hosts stringSlice                     A list of space-separated host names in a certificate signing request to a parent fabric-ca-server
          --csr.serialnumber string                   The serial number in a certificate signing request to a parent fabric-ca-server
          --db.datasource string                      Data source which is database specific (default "fabric-ca-server.db")
          --db.tls.certfiles stringSlice              A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --db.tls.client.certfile string             PEM-encoded certificate file when mutual authenticate is enabled
          --db.tls.client.keyfile string              PEM-encoded key file when mutual authentication is enabled
          --db.type string                            Type of database; one of: sqlite3, postgres, mysql (default "sqlite3")
      -d, --debug                                     Enable debug level logging
      -H, --home string                               Server's home directory (default "/etc/hyperledger/fabric-ca")
          --intermediate.enrollment.label string      Label to use in HSM operations
          --intermediate.enrollment.profile string    Name of the signing profile to use in issuing the certificate
          --intermediate.parentserver.caname string   Name of the CA to connect to on fabric-ca-server
      -u, --intermediate.parentserver.url string      URL of the parent fabric-ca-server (e.g. http://<username>:<password>@<address>:<port)
          --intermediate.tls.certfiles stringSlice    A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --intermediate.tls.client.certfile string   PEM-encoded certificate file when mutual authenticate is enabled
          --intermediate.tls.client.keyfile string    PEM-encoded key file when mutual authentication is enabled
          --ldap.attribute.names stringSlice          The names of LDAP attributes to request on an LDAP search
          --ldap.enabled                              Enable the LDAP client for authentication and attributes
          --ldap.groupfilter string                   The LDAP group filter for a single affiliation group (default "(memberUid=%s)")
          --ldap.tls.certfiles stringSlice            A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --ldap.tls.client.certfile string           PEM-encoded certificate file when mutual authenticate is enabled
          --ldap.tls.client.keyfile string            PEM-encoded key file when mutual authentication is enabled
          --ldap.url string                           LDAP client URL of form ldap://adminDN:adminPassword@host[:port]/base
          --ldap.userfilter string                    The LDAP user filter to use when searching for users (default "(uid=%s)")
      -p, --port int                                  Listening port of fabric-ca-server (default 7054)
          --registry.maxenrollments int               Maximum number of enrollments; valid if LDAP not enabled (default -1)
          --tls.certfile string                       PEM-encoded TLS certificate file for server's listening port (default "tls-cert.pem")
          --tls.clientauth.certfiles stringSlice      A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --tls.clientauth.type string                Policy the server will follow for TLS Client Authentication. (default "noclientcert")
          --tls.enabled                               Enable TLS on the listening port
          --tls.keyfile string                        PEM-encoded TLS key for server's listening port

    Use "fabric-ca-server [command] --help" for more information about a command.

#### 2.客户端命令行。

    Hyperledger Fabric Certificate Authority Client

    Usage:
      fabric-ca-client [command]

    Available Commands:
      affiliation Manage affiliations
      enroll      Enroll an identity
      gencrl      Generate a CRL
      gencsr      Generate a CSR
      getcacert   Get CA certificate chain
      identity    Manage identities
      reenroll    Reenroll an identity
      register    Register an identity
      revoke      Revoke an identity
      version     Prints Fabric CA Client version

    Flags:
          --caname string                  Name of CA
          --csr.cn string                  The common name field of the certificate signing request
          --csr.hosts stringSlice          A list of space-separated host names in a certificate signing request
          --csr.names stringSlice          A list of comma-separated CSR names of the form <name>=<value> (e.g. C=CA,O=Org1)
          --csr.serialnumber string        The serial number in a certificate signing request
      -d, --debug                          Enable debug level logging
          --enrollment.attrs stringSlice   A list of comma-separated attribute requests of the form <name>[:opt] (e.g. foo,bar:opt)
          --enrollment.label string        Label to use in HSM operations
          --enrollment.profile string      Name of the signing profile to use in issuing the certificate
      -H, --home string                    Client's home directory (default "$HOME/.fabric-ca-client")
          --id.affiliation string          The identity's affiliation
          --id.attrs stringSlice           A list of comma-separated attributes of the form <name>=<value> (e.g. foo=foo1,bar=bar1)
          --id.maxenrollments int          The maximum number of times the secret can be reused to enroll (default CA's Max Enrollment)
          --id.name string                 Unique name of the identity
          --id.secret string               The enrollment secret for the identity being registered
          --id.type string                 Type of identity being registered (e.g. 'peer, app, user') (default "client")
      -M, --mspdir string                  Membership Service Provider directory (default "msp")
      -m, --myhost string                  Hostname to include in the certificate signing request during enrollment (default "$HOSTNAME")
      -a, --revoke.aki string              AKI (Authority Key Identifier) of the certificate to be revoked
      -e, --revoke.name string             Identity whose certificates should be revoked
      -r, --revoke.reason string           Reason for revocation
      -s, --revoke.serial string           Serial number of the certificate to be revoked
          --tls.certfiles stringSlice      A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --tls.client.certfile string     PEM-encoded certificate file when mutual authenticate is enabled
          --tls.client.keyfile string      PEM-encoded key file when mutual authentication is enabled
      -u, --url string                     URL of fabric-ca-server (default "http://localhost:7054")

    Use "fabric-ca-client [command] --help" for more information about a command.

请注意，作为字符串切片（列表）的命令行选项可以通过使用以逗号分隔的列表元素指定选项或多次指定选项来指定，每个选项都包含组成列表的字符串值。 例如，要为`csr.hosts`选项指定`host1`和h`ost2`，可以传递`--csr.hosts'host1，host2'`或`--csr.hosts host1 --csr.hosts host2`。 使用以前的格式时，请确保在逗号前后没有空格。

### 六.配置设置

Fabric CA提供3种方法来配置Fabric CA服务器和客户端的设置。 优先顺序是：

* CLI 标志
* 环境变量
* 配置文件

在本文档的其余部分中，我们指的是对配置文件进行更改。 但是，可以通过环境变量或CLI标志覆盖配置文件更改。

例如，如果我们在客户端配置文件中具有以下内容：

    tls:
      # Enable TLS (default: false)
      enabled: false

      # TLS for the client's listenting port (default: false)
      certfiles:
      client:
        certfile: cert.pem
        keyfile:

以下环境变量可用于覆盖配置文件中的`cert.pem`设置：

    export FABRIC_CA_CLIENT_TLS_CLIENT_CERTFILE=cert2.pem
    
如果我们想覆盖环境变量和配置文件，我们可以使用命令行标志。

    fabric-ca-client enroll --tls.client.certfile cert3.pem
    
同样的方法适用于fabric-ca-server，除了不使用FABIRC_CA_CLIENT作为环境变量的前缀外，还使用FABRIC_CA_SERVER。

#### 文件路径

Fabric CA服务器和客户端配置文件中指定文件名的所有属性都支持相对路径和绝对路径。 相对路径相对于配置文件所在的config目录。 例如，如果config目录是〜/ config，并且tls部分如下所示，则Fabric CA服务器或客户端将在〜/config目录中查找root.pem文件，在〜/config中查找cert.pem文件/certs目录和/abs/ path目录中的key.pem文件

    tls:
      enabled: true
      certfiles:
        - root.pem
      client:
        certfile: certs/cert.pem
        keyfile: /abs/path/key.pem


## 第三节:Fabric CA服务端

本节介绍Fabric CA服务器。

启动之前，您可以初始化Fabric CA服务器。 这会提供了一个机会用于生成可在启动服务器之前进行审查和自定义的默认配置文件。

Fabric CA服务器主目录的确定方式如下：

* 如果设置了-home命令行选项，请使用其值
* 否则，如果设置了FABRIC_CA_SERVER_HOME环境变量，则使用其值
* 否则，如果FABRIC_CA_HOME环境变量已设置，请使用其值
* 否则，如果设置了CA_CFG_PATH环境变量，请使用其值
* 否则，使用当前工作目录

对于此服务器部分的其余部分，我们假设您已将FABRIC_CA_HOME环境变量设置为$HOME/fabric-ca/server。

以下说明假定服务器配置文件存在于服务器的主目录中。

### 一.初始化服务器

初始化Fabric CA服务器的命令如下：

    fabric-ca-server init -b admin:adminpw

禁用LDAP时，需要使用-b（引导程序标识）选项进行初始化。 启动Fabric CA服务器至少需要一个引导程序标识; 这个身份是服务器管理员。

服务器配置文件包含可配置的证书签名请求（CSR）部分。 以下是CSR示例。

    cn: fabric-ca-server
    names:
       - C: US
         ST: "North Carolina"
         L:
         O: Hyperledger
         OU: Fabric
    hosts:
      - host1.example.com
      - localhost
    ca:
       expiry: 131400h
       pathlength: 1

以上所有字段都与由`fabric-ca-server init`生成的X.509签名密钥和证书。 这对应于服务器配置文件中的`ca.certfile`和`ca.keyfile`文件。 这些字段如下所示：

* cn是通用名称
* O是组织的名称
* OU是组织单位
* L是位置或城市
* ST是国家
* C是国家

如果需要CSR的自定义值，则可以自定义配置文件，删除由`ca.certfile`和`ca.keyfil`e配置项指定的文件，然后再次运行`fabric-ca-server init -b admin：adminpw`命令。

除非指定了`-u <parent-fabric-ca-server-URL>`选项，否则`fabric-ca-server init`命令会生成自签名CA证书。 如果指定了-u，则服务器的CA证书由父Fabric CA服务器签署。 为了向父Fabric CA服务器进行身份验证，URL的格式必须为`<scheme>://<enrollmentID>：<secret> @ <host>：<port>`，其中`<enrollmentID>`和`<secret>`对应于 `'hf.IntermediateCA'`属性的值等于`'true'`。 `fabric-ca-server init`命令还会在服务器的主目录中生成一个名为`fabric-ca-server-config.yaml`的默认配置文件。

如果您希望Fabric CA服务器使用您提供的CA签名证书和密钥文件，则必须将文件分别放置在由`ca.certfile`和`ca.keyfile引`用的位置。 两个文件都必须是PEM编码的，并且不得加密。 更具体地说，CA证书文件的内容必须以`----- BEGIN CERTIFICATE -----`开头，并且密钥文件的内容必须以`----- BEGIN PRIVATE KEY -----`开头，而不是 `-----BEGIN ENCRYPTED PRIVATE KEY-----`。

##### 算法和密钥长度

可以定制CSR以生成支持椭圆曲线（ECDSA）的X.509证书和密钥。 以下设置是使用曲线prime256v1和签名算法`ecdsa-with-SHA256`实施椭圆曲线数字签名算法（ECDSA）的一个示例：

    key:
       algo: ecdsa
       size: 256

算法的选择和密钥的长度选择基于安全性的需要

椭圆曲线（ECDSA）提供了下面的密钥长度选择：

| 长度 |	ASN1 OID |  	  签名算法    |
|-----|-----------|-------------------|
| 256 |	prime256v1|	ecdsa-with-SHA256 |
| 384 |	secp384r1 |	ecdsa-with-SHA384 |
| 521 |	secp521r1 |	ecdsa-with-SHA512 |

### 二.启动服务器

启动服务器的命令如下：

    fabric-ca-server start -b <admin>:<adminpw>

如果服务器以前没有被初始化，它将在第一次启动时自行初始化。 在初始化期间，如果服务器尚不存在，服务器将生成`ca-cert.pem`和`ca-key.pem`文件，并且如果该文件不存在，还会创建一个默认配置文件。 

除非Fabric CA服务器配置为使用LDAP，否则必须至少配置一个预先注册的引导程序标识，以便您注册和注册其他标识。 -b选项指定引导标识的名称和密码。

要使Fabric CA服务器在https而不是http上进行侦听，请将`tls.enabled`设置为`true`。

要限制相同密码可用于注册的次数，请将配置文件中的`registry.maxenrollments`设置为适当的值。 如果将值设置为1，则Fabric CA服务器允许密码仅针对特定注册ID使用一次。 如果将该值设置为-1，Fabric CA服务器不会限制密钥可以重新用于注册的次数。 默认值是-1。 将该值设置为0，Fabric CA服务器将禁止所有身份的注册，并且不允许注册身份。

Fabric CA服务监听的端口是7054。

如果您不想将Fabric CA服务器配置为在集群中运行或使用LDAP，则可以跳到结构CA客户端部分。

### 三.配置数据库

本节介绍如何配置Fabric CA服务器以连接PostgreSQL或MySQL数据库。默认数据库是SQLite，Fabric CA服务器主目录中的默认数据库文件是fabric-ca-server.db。

如果您不关心在群集中运行Fabric CA服务器，则可以跳过本节; 否则，您必须按照下面所述配置PostgreSQL或MySQL。 Fabric CA在集群设置中支持以下数据库版本：

* PostgreSQL: 9.5.5或者更高
* MySQL: 5.7或者更高

#### 1.PostgreSQL

The following sample may be added to the server’s configuration file in order to connect to a PostgreSQL database. Be sure to customize the various values appropriately. There are limitations on what characters are allowed in the database name. Please refer to the following Postgres documentation for more information: https://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS



以下示例可能会添加到服务器的配置文件中，以便连接到PostgreSQL数据库。 一定要适当地自定义各种值。 数据库名称中允许使用哪些字符有限制。 有关更多信息，请参阅以下Postgres文档：

https://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS

    db:
      type: postgres
      datasource: host=localhost port=5432 user=Username password=Password dbname=fabric_ca sslmode=verify-full

指定sslmode配置SSL身份验证的类型。 sslmode的有效值为：

|    模式   |                     描述                     |
|----------|----------------------------------------------|
|   禁用	  |  非SSL                                       |                                        
|   要求	  |  始终SSL（跳过验证）                           |
|  认证-ca  |  始终SSL（验证服务器提供的证书是否由受信任的CA签名） |
|  验证全   |  始终SSL（验证服务器提供的证书是否由受信任的CA签名） |   
|  服务器   |  主机名与证书中的主机名相匹配                     |

如果您想使用TLS，则必须指定Fabric CA服务器配置文件中的`db.tls`部分。 如果在`PostgreSQL`服务器上启用了SSL客户端身份验证，则还必须在`db.tls.client`部分中指定客户端证书和密钥文件。 以下是`db.tls`部分的示例：

    db:
      ...
      tls:
          enabled: true
          certfiles:
            - db-server-cert.pem
          client:
                certfile: db-client-cert.pem
                keyfile: db-client-key.pem


certfiles-PEM编码的可信根证书文件列表。
certfile和密钥文件-结构CA服务器用于与PostgreSQL服务器安全通信的PEM编码证书和密钥文件

#### 2.PostgreSQL SSL配置

##### 在PostgreSQL服务器上配置SSL的基本说明：

在postgresql.conf中，取消注释SSL并设置为“on”（SSL = on）
将证书和密钥文件放在PostgreSQL数据目录中。

有关生成自签名证书的说明：https://www.postgresql.org/docs/9.5/static/ssl-tcp.html

注意：自签名证书仅用于测试目的，不应在生产环境中使用

##### PostgreSQL服务器-需要客户端证书

* 将您信任的证书颁发机构（CA）的证书放入PostgreSQL数据目录中的文件root.crt中
* 在postgresql.conf中，将“ssl_ca_file”设置为指向客户端的根证书（CA cert）
* 在pg_hba.conf中的相应hostssl行上将clientcert参数设置为1。

有关在PostgreSQL服务器上配置SSL的更多详细信息，请参阅以下PostgreSQL文档：https://www.postgresql.org/docs/9.4/static/libpq-ssl.html

#### 2.Mysql

以下示例可能会添加到结构CA服务器配置文件中，以便连接到MySQL数据库。 一定要适当地自定义各种值。 数据库名称中允许使用哪些字符有限制。 有关更多信息，请参阅以下MySQL文档：https：//dev.mysql.com/doc/refman/5.7/en/identifiers.html

在MySQL 5.7.X中，某些模式会影响服务器是否允许“0000-00-00”作为有效日期。 可能需要放松MySQL服务器使用的模式。 我们希望允许服务器能够接受零日期值。

在my.cnf中，找到配置选项sql_mode并删除NO_ZERO_DATE（如果存在）。 进行此更改后重新启动MySQL服务器。

请参阅以下有关不同可用模式的MySQL文档，并为正在使用的特定版本的MySQL选择适当的设置。

https://dev.mysql.com/doc/refman/5.7/en/sql-mode.html

    db:
      type: mysql
      datasource: root:rootpw@tcp(localhost:3306)/fabric_ca?parseTime=true&tls=custom

如果通过TLS连接到MySQL服务器，那么也需要`db.tls.client`部分，如上面的PostgreSQL部分所述。

##### MySQL SSL配置

1.打开或创建服务器的my.cnf文件。 在[mysqld]部分添加或取消注释下面的行。 这些应指向服务器的密钥和证书以及根CA证书。

有关创建服务器和客户端认证的说明：http://dev.mysql.com/doc/refman/5.7/en/creating-ssl-files-using-openssl.html

[mysqld] ssl-ca=ca-cert.pem ssl-cert=server-cert.pem ssl-key=server-key.pem

可以运行以下查询以确认SSL已启用。

mysql> SHOW GLOBAL VARIABLES LIKE ‘have_%ssl’;

应该会看到：

| Variable_name |	Value  |
|---------------|----------|
| have_openssl	|   YES    |
| have_ssl	    |   YES    |

2.服务器端SSL配置完成后，下一步是创建一个有权通过SSL访问MySQL服务器的用户。 为此，请登录到MySQL服务器，然后键入：

mysql> GRANT ALL PRIVILEGES ON . TO ‘ssluser’@’%’ IDENTIFIED BY ‘password’ REQUIRE SSL; mysql> FLUSH PRIVILEGES;

如果您想给出用户访问服务器的特定IP地址，请将'％'更改为特定的IP地址。

##### MySQL服务器-需要客户端证书

安全连接的选项与服务器端使用的选项类似。

* ssl-ca标识证书颁发机构（CA）证书。 如果使用此选项，则必须指定服务器使用的相同证书。
* ssl-cert标识MySQL服务器的证书。
* ssl-key标识MySQL服务器的私钥。

假设您要使用无特殊加密要求的帐户进行连接，或者使用包含REQUIRE SSL选项的GRANT语句创建该帐户。 作为一组推荐的安全连接选项，至少使用-ssl-cert和-ssl-key选项启动MySQL服务器。 然后在服务器配置文件中设置db.tls.certfiles属性并启动Fabric CA服务器。

要要求指定客户端证书，请使用REQUIRE X509选项创建帐户。 然后客户端还必须指定适当的客户端密钥和证书文件; 否则，MySQL服务器将拒绝连接。 要为Fabric CA服务器指定客户端密钥和证书文件，请设置db.tls.client.cert文件和db.tls.client.keyfile配置属性。

#### 3.配置LDAP

fabric CA服务器可以配置为从LDAP服务器读取。

特别是，Fabric CA服务器可能会连接到LDAP服务器以执行以下操作：

* 在注册之前验证身份
* 检索用于授权的身份的属性值。

修改Fabric CA服务器的配置文件的LDAP部分，将服务器配置为连接到LDAP服务器。

    ldap:
       # Enables or disables the LDAP client (default: false)
       enabled: false
       # The URL of the LDAP server
       url: <scheme>://<adminDN>:<adminPassword>@<host>:<port>/<base>
       userfilter: <filter>
       attribute:
          # 'names' is an array of strings that identify the specific attributes
          # which are requested from the LDAP server.
          names: <LDAPAttrs>
          # The 'converters' section is used to convert LDAP attribute values
          # to fabric CA attribute values.
          #
          # For example, the following converts an LDAP 'uid' attribute
          # whose value begins with 'revoker' to a fabric CA attribute
          # named "hf.Revoker" with a value of "true" (because the expression
          # evaluates to true).
          #    converters:
          #       - name: hf.Revoker
          #         value: attr("uid") =~ "revoker*"
          #
          # As another example, assume a user has an LDAP attribute named
          # 'member' which has multiple values of "dn1", "dn2", and "dn3".
          # Further assume the following configuration.
          #    converters:
          #       - name: myAttr
          #         value: map(attr("member"),"groups")
          #    maps:
          #       groups:
          #          - name: dn1
          #            value: orderer
          #          - name: dn2
          #            value: peer
          # The value of the user's 'myAttr' attribute is then computed to be
          # "orderer,peer,dn3".  This is because the value of 'attr("member")' is
          # "dn1,dn2,dn3", and the call to 'map' with a 2nd argument of
          # "group" replaces "dn1" with "orderer" and "dn2" with "peer".
          converters:
            - name: <fcaAttrName>
              value: <fcaExpr>
          maps:
            <mapName>:
                - name: <from>
                  value: <to>


* scheme:是ldap或ldaps之一
* adminDN:是管理员用户的专有名称
* pass:管理员用户密码
* host:LDAP服务器的主机的IP地址
* port:是可选的端口号，其中ldap的缺省值为389，ldaps的缺省值为636;
* base:是用于搜索的LDAP树的可选根目录
* filter:是在搜索时将过滤器用于将登录用户名转换为独特名称。 例如：（uid=％s）的值将使用值为登录用户名的uid属性的值来搜索LDAP条目。 同样，（电子邮件=％s）可用于使用电子邮件地址登录。
* LDAPAttrs:是代表用户从LDAP服务器请求的LDAP属性名称数组;
* attribute.converters部分用于将LDAP属性转换为fabric CA属性，其中*fcaAttrName是结构CA属性的名称; *fcaExpr是一个表达式，其评估值被分配给结构CA属性。 例如，假设<LDAPAttrs>是[“uid”]，<fcaAttrName>是'hf.Revoker'，并且<fcaExpr>是'attr（“uid”）=〜“revoker *”'。 这意味着代表用户从LDAP服务器请求名为“uid”的属性。 如果用户'uid'LDAP属性的值以'revoker'开头，那么用户将被赋予'true'值作为'hf.Revoker'属性。 否则，用户被赋予'hf.Revoker'属性的'false'值。
* attribute.maps部分用于映射LDAP响应值。 典型的用例是将与LDAP组关联的独特名称映射到身份类型。

LDAP表达式语言使用https://github.com/Knetic/govaluate/blob/master/MANUAL.md中描述的govaluate包。 这定义了诸如“=〜”之类的运算符和诸如“revoker *”之类的文字，这是一个正则表达式。 扩展基础高级语言的LDAP特定变量和函数如下所示：

* DN:是一个等于用户可分辨名称的变量。
* affiliation:是一个等于用户隶属关系的变量。
* attr:是一个需要1或2个参数的函数。 第一个参数是一个LDAP属性名称。 第二个参数是一个分隔符字符串，用于将多个值连接到单个字符串中; 默认分隔符字符串是“，”。 attr函数总是返回一个'string'类型的值。
* map:是一个需要2个参数的函数。 第一个参数是任何字符串。 第二个参数是一个映射的名字，用来对第一个参数的字符串进行字符串替换。
* if:是一个函数，它需要3个参数，其中第一个参数必须解析为布尔值。 如果它的计算结果为true，则返回第二个参数; 否则，返回第三个参数。

例如：如果用户具有以“O = org1，C = US”结尾的可分辨名称，或者如果用户具有以“org1.dept2”开头的联系并且还具有“admin” 属性为“true”。

##### DN =~ “*O=org1,C=US” || (affiliation =~ “org1.dept2.*” && attr(‘admin’) = ‘true’)

注意：由于attr函数总是返回一个'string'类型的值，所以数字操作符不能用于构造表达式。 例如，以下不是有效的表达式：

    value: attr("gidNumber) >= 10000 && attr("gidNumber) < 10006
    
或者，如下所示的用引号引起来的正则表达式可用于返回等效的结果：

    value: attr("gidNumber") =~ "1000[0-5]$" || attr("mail") == "root@example.com"
    
以下是DockLD镜像位于https://github.com/osixia/docker-openldap的OpenLDAP服务器默认设置的示例配置部分。

    ldap:
       enabled: true
       url: ldap://cn=admin,dc=example,dc=org:admin@localhost:10389/dc=example,dc=org
       userfilter: (uid=%s)

请参阅FABRIC_CA/scripts/run-ldap-tests了解启动OpenLDAP docker镜像，配置它，在FABRIC_CA/cli/server/ldap/ldap_test.go中运行LDAP测试并停止OpenLDAP服务器的脚本。

当配置LDAP时，注册工作如下：

Fabric CA客户端或客户端SDK会发送带有基本授权标头的注册请求。

Fabric CA服务器接收注册请求，解码授权头中的身份名称和密码，使用配置文件中的“userfilter”查找与身份名称关联的DN（Distinquished Name），然后尝试使用LDAP绑定身份的密码。 如果LDAP绑定成功，则注册处理将被授权并可继续。

#### 4.配置集群

您可以使用任何IP sprayer将负载均衡添加到Fabric CA服务器集群。 本节提供了一个如何设置Haproxy以路由到Fabric CA服务器群集的示例。 确保更改主机名和端口以反映Fabric CA Server的设置。

###### haproxy.conf

    global
          maxconn 4096
          daemon

    defaults
          mode http
          maxconn 2000
          timeout connect 5000
          timeout client 50000
          timeout server 50000

    listen http-in
          bind *:7054
          balance roundrobin
          server server1 hostname1:port
          server server2 hostname2:port
          server server3 hostname3:port

注意：如果使用TLS，则需要使用tcp模式。

#### 5.设置多个CA

fabric-ca服务器默认由一个默认的CA组成。 但是，可以使用cafiles或cacount配置选项将其他CA添加到单个服务器。 每个额外的CA将拥有自己的主目录。

##### cacount:

Cacount提供了一种快速启动X个默认额外CA的快速方法。 主目录将相对于服务器目录。 使用此选项，目录结构如下所示：

    --<Server Home>
      |--ca
        |--ca1
        |--ca2

每个额外的CA将在其主目录中获得一个默认配置文件，在配置文件中它将包含一个唯一的CA名称。

例如，以下命令将启动2个默认CA实例：

    fabric-ca-server start -b admin:adminpw --cacount 2

##### cafiles：

如果在使用cafiles配置选项时未提供绝对路径，则CA主目录将相对于服务器目录。

要使用此选项，必须已为每个要启动的CA生成并配置CA配置文件。 每个配置文件必须具有唯一的CA名称和通用名称（CN），否则服务器将无法启动，因为这些名称必须是唯一的。 CA配置文件将覆盖任何默认CA配置，并且CA配置文件中的任何缺失选项将被默认CA的值替换。

优先顺序如下：

1.CA配置文件
2.默认的CA CLI标志
3.默认CA环境变量
4.默认的CA配置文件

CA配置文件必须至少包含以下内容：

    ca:
    # Name of this CA
    name: <CANAME>

    csr:
      cn: <COMMONNAME>

您可以按如下方式配置您的目录结构：

    --<Server Home>
      |--ca
        |--ca1
          |-- fabric-ca-config.yaml
        |--ca2
          |-- fabric-ca-config.yaml
          
例如，以下命令将启动两个自定义的CA实例：

    fabric-ca-server start -b admin:adminpw --cafiles ca/ca1/fabric-ca-config.yaml
    --cafiles ca/ca2/fabric-ca-config.yaml
    
#### 6.注册中间CA    
 
 为了为中间CA创建CA签名证书，中间CA必须按照fabric-ca-client向CA注册的相同方式注册父CA. 这是通过使用-u选项来指定父CA的URL以及注册ID和密码来完成的，如下所示。 与此注册ID关联的身份必须具有名称为“hf.IntermediateCA”和值“true”的属性。 已颁发证书的CN（或通用名称）将被设置为注册ID。 如果中间CA尝试明确指定CN值，则会发生错误。
 
    fabric-ca-server start -b admin:adminpw -u http://<enrollmentID>:<secret>@<parentserver>:<parentport>

 #### 7.升级服务器
 
在升级Fabric CA客户端之前，必须升级Fabric CA服务器。 升级之前，建议备份当前数据库：
 
* 如果使用sqlite3，请备份当前数据库文件（默认情况下命名为fabric-ca-server.db）。
* 对于其他数据库类型，请使用适当的备份/复制机制。
 
要升级Fabric CA服务器的单个实例：
 
1.停止fabric-ca-server进程。
2.确保当前数据库已备份。
3.将之前的fabric-ca-server二进制文件替换为升级版本。
4.启动fabric-ca-server进程。
5.使用以下命令验证fabric-ca-server进程是否可用，其中<host>是启动服务器的主机名：

    fabric-ca-client getcacert -u http://<host>:7054

##### 升级群集：

要使用MySQL或Postgres数据库升级fabric-ca-server实例的集群，请执行以下步骤。 我们假设您正在使用haproxy向host1和host2上的两个fabric-ca-server集群成员（分别在端口7054上侦听）进行负载均衡。完成此过程后，您将对升级的fabric-ca-server集群成员进行负载平衡 在host3和host4上分别监听端口7054。

为了使用haproxy stats监视更改，启用统计信息收集。 将以下行添加到haproxy配置文件的全局部分：

    stats socket /var/run/haproxy.sock mode 666 level operator
    stats timeout 2m
 
重新启动haproxy以获取更改：

    # haproxy -f <configfile> -st $(pgrep haproxy)

要显示haproxy“show stat”命令的摘要信息，以下函数可能对分析返回的大量CSV数据非常有用：
 
    haProxyShowStats() {
       echo "show stat" | nc -U /var/run/haproxy.sock |sed '1s/^# *//'|
          awk -F',' -v fmt="%4s %12s %10s %6s %6s %4s %4s\n" '
             { if (NR==1) for (i=1;i<=NF;i++) f[tolower($i)]=i }
             { printf fmt, $f["sid"],$f["pxname"],$f["svname"],$f["status"],
                           $f["weight"],$f["act"],$f["bck"] }'
    }
 
1.最初，您的haproxy配置文件与以下内容类似：
 
    server server1 host1:7054 check
    server server2 host2:7054 check
 
将此配置更改为以下内容：

    server server1 host1:7054 check backup
    server server2 host2:7054 check backup
    server server3 host3:7054 check
    server server4 host4:7054 check
 
 2.使用新配置重新启动HA代理，如下所示：
 
    haproxy -f <configfile> -st $(pgrep haproxy)

“haProxyShowStats”现在将反映修改的配置，包含两个活动的旧版本备份服务器和两个（尚未启动）升级服务器：

    sid   pxname      svname  status  weig  act  bck
      1   fabric-cas  server3   DOWN     1    1    0
      2   fabric-cas  server4   DOWN     1    1    0
      3   fabric-cas  server1     UP     1    0    1
      4   fabric-cas  server2     UP     1    0    1

3.在host3和host4上安装fabric-ca-server的升级二进制文件。 host3和host4上新升级的服务器应该配置为使用与host1和host2上较旧的服务器相同的数据库。 启动升级后的服务器后，数据库将自动迁移。 haproxy会将所有新流量转发给升级后的服务器，因为它们未配置为备份服务器。 在继续之前，使用“fabric-ca-client getcacert”命令验证群集仍然正常工作。 此外，“haProxyShowStats”现在应该反映所有服务器都处于活动状态，类似于以下内容：
 
    sid   pxname      svname  status  weig  act  bck
      1   fabric-cas  server3    UP     1    1    0
      2   fabric-cas  server4    UP     1    1    0
      3   fabric-cas  server1    UP     1    0    1
      4   fabric-cas  server2    UP     1    0    1


 
 
 
 
 
 
 
 
 
 
 
    
