# 第三章：HyperLedger证书认证服务

本章的内容的构建来自“主”分支

Hyperledger fabric CA是Hyperledger fabric的认证中心（CA）。

它提供了以下功能：

* 注册身份，或者连接到LDAP作为用户注册表
* 发放登记证书（ECerts）
* 证书更新和撤销

Hyperledger fabric CA由服务器和客户端组件组成。

如果您兴趣参与Hyperledger Fabric CA的开发人员，请参阅Fabric CA存储库以获取更多信息。

## 第一节.概述

下图说明了Hyperledger Fabric CA服务器如何适用于整体Hyperledger Fabric架构。

图片1： 
    ![图片1](https://github.com/guoshijiang/Hyperledger_fabric_v1.0/blob/master/img/1.png "图片1")

有两种与Hyperledger Fabric CA服务器进行交互的方式：通过Hyperledger Fabric CA客户端或通过某个Fabric SDK进行交互。 与Hyperledger Fabric CA服务器的所有通信均通过REST API提供。 有关这些REST API的swagger文档，请参阅fabric-ca/swagger/swagger-fabric-ca.json。

Hyperledger Fabric CA客户端或SDK可能连接到Hyperledger Fabric CA服务器群集中的服务器。 这在图的右上部分中说明。 客户端路由到HA代理端点，该端点将流量负载平衡到fabric-ca-server集群成员之一。

群集中的所有Hyperledger Fabric CA服务器都共享相同的数据库以跟踪身份和证书。 如果配置了LDAP，则身份信息将保存在LDAP中而不是数据库中。

一台服务器可能包含多个CA。 每个CA都是根CA或中间CA. 每个中间CA都有一个父CA，它是根CA或另一个中间CA.

## 第二节.Hyperledger fabric CA入门

### 一.使用的必要条件

* 安装go 1.9+ 
* 设置正确的GOPATH环境变量
* 安装libtool和libtdhl-dev软件包

以下内容是在Ubuntu上安装libtool依赖项：

    sudo apt install libtool libltdl-dev

以下内容是在MacOSX上安装libtool依赖项：

    brew install libtool

注意：如果您通过Homebrew安装libtool，则libtldl-dev在MacOSX上不是必需的

有关libtool的更多信息，请点击：https://www.gnu.org/software/libtool。

有关libltdl-dev的更多信息，请点击：https://www.gnu.org/software/libtool/manual/html_node/Using-libltdl.html。

### 二.安装

以下安装将会在$GOPATH/bin中安装fabric-ca-server和fabric-ca-client的二进制文件。

    go get -u github.com/hyperledger/fabric-ca/cmd/...

注意：如果你已经克隆了fabric-ca代码，请在运行上面的“go get”命令之前确保您位于master分支上。 否则，您可能会看到以下错误：

        <gopath>/src/github.com/hyperledger/fabric-ca; git pull --ff-only
        There is no tracking information for the current branch.
        Please specify which branch you want to merge with.
        See git-pull(1) for details.

            git pull <remote> <branch>

        If you wish to set tracking information for this branch you can do so with:

            git branch --set-upstream-to=<remote>/<branch> tlsdoc

        package github.com/hyperledger/fabric-ca/cmd/fabric-ca-client: exit status 1

### 三.本地启动服务器

以下命令以默认设置启动fabric-ca-server。

    fabric-ca-server start -b admin:adminpw

-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。

一个名为fabric-ca-server-config.yaml的默认配置文件将在可以自定义的本地目录中创建。

### 四.通过Docker启动服务

#### 1.Docker Hub

点击这个链接：https://hub.docker.com/r/hyperledger/fabric-ca/tags/ 

找到与您想要提取的fabric-ca的体系结构和版本相匹配的标签。

到这个目录下：$GOPATH/src/github.com/hyperledger/fabric-ca/docker/server并在编辑器中打开docker-compose.yml。

更改镜像行以反映您之前找到的标签。 该文件对于Beta版本的x86体系结构也是这样的。

    fabric-ca-server:
      image: hyperledger/fabric-ca:x86_64-1.0.0-beta
      container_name: fabric-ca-server
      ports:
        - "7054:7054"
      environment:
        - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      volumes:
        - "./fabric-ca-server:/etc/hyperledger/fabric-ca-server"
      command: sh -c 'fabric-ca-server start -b admin:adminpw'

在与docker-compose.yml文件相同的目录中打开终端并执行以下命令：

    # docker-compose up -d

如果尚未存在，则会将组合文件中指定的fabric-ca镜像下拉，然后启动fabric-ca服务器的实例。

#### 2.构建你自己的Docker镜像

您可以通过docker-compose构建并启动服务器，如下所示。

    cd $GOPATH/src/github.com/hyperledger/fabric-ca
    make docker
    cd docker/server
    docker-compose up -d
    
hyperled/fabric-ca docker镜像包含fabric-ca-server和fabric-ca-client。

    # cd $GOPATH/src/github.com/hyperledger/fabric-ca
    # FABRIC_CA_DYNAMIC_LINK=true make docker
    # cd docker/server
    # docker-compose up -d
    
### 五.探索Fabric CA CLI

本节仅为方便起见提供Fabric CA服务器和客户端的使用消息。以下部分提供了其他使用信息。

#### 1.服务器命令行

    Hyperledger Fabric Certificate Authority Server

    Usage:
      fabric-ca-server [command]

    Available Commands:
      init        Initialize the fabric-ca server
      start       Start the fabric-ca server
      version     Prints Fabric CA Server version

    Flags:
          --address string                            Listening address of fabric-ca-server (default "0.0.0.0")
      -b, --boot string                               The user:pass for bootstrap admin which is required to build default config file
          --ca.certfile string                        PEM-encoded CA certificate file (default "ca-cert.pem")
          --ca.chainfile string                       PEM-encoded CA chain file (default "ca-chain.pem")
          --ca.keyfile string                         PEM-encoded CA key file
      -n, --ca.name string                            Certificate Authority name
          --cacount int                               Number of non-default CA instances
          --cafiles stringSlice                       A list of comma-separated CA configuration files
          --cfg.affiliations.allowremove              Enables removal of affiliations dynamically
          --cfg.identities.allowremove                Enables removal of identities dynamically
          --crl.expiry duration                       Expiration for the CRL generated by the gencrl request (default 24h0m0s)
          --crlsizelimit int                          Size limit of an acceptable CRL in bytes (default 512000)
          --csr.cn string                             The common name field of the certificate signing request to a parent fabric-ca-server
          --csr.hosts stringSlice                     A list of space-separated host names in a certificate signing request to a parent fabric-ca-server
          --csr.serialnumber string                   The serial number in a certificate signing request to a parent fabric-ca-server
          --db.datasource string                      Data source which is database specific (default "fabric-ca-server.db")
          --db.tls.certfiles stringSlice              A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --db.tls.client.certfile string             PEM-encoded certificate file when mutual authenticate is enabled
          --db.tls.client.keyfile string              PEM-encoded key file when mutual authentication is enabled
          --db.type string                            Type of database; one of: sqlite3, postgres, mysql (default "sqlite3")
      -d, --debug                                     Enable debug level logging
      -H, --home string                               Server's home directory (default "/etc/hyperledger/fabric-ca")
          --intermediate.enrollment.label string      Label to use in HSM operations
          --intermediate.enrollment.profile string    Name of the signing profile to use in issuing the certificate
          --intermediate.parentserver.caname string   Name of the CA to connect to on fabric-ca-server
      -u, --intermediate.parentserver.url string      URL of the parent fabric-ca-server (e.g. http://<username>:<password>@<address>:<port)
          --intermediate.tls.certfiles stringSlice    A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --intermediate.tls.client.certfile string   PEM-encoded certificate file when mutual authenticate is enabled
          --intermediate.tls.client.keyfile string    PEM-encoded key file when mutual authentication is enabled
          --ldap.attribute.names stringSlice          The names of LDAP attributes to request on an LDAP search
          --ldap.enabled                              Enable the LDAP client for authentication and attributes
          --ldap.groupfilter string                   The LDAP group filter for a single affiliation group (default "(memberUid=%s)")
          --ldap.tls.certfiles stringSlice            A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --ldap.tls.client.certfile string           PEM-encoded certificate file when mutual authenticate is enabled
          --ldap.tls.client.keyfile string            PEM-encoded key file when mutual authentication is enabled
          --ldap.url string                           LDAP client URL of form ldap://adminDN:adminPassword@host[:port]/base
          --ldap.userfilter string                    The LDAP user filter to use when searching for users (default "(uid=%s)")
      -p, --port int                                  Listening port of fabric-ca-server (default 7054)
          --registry.maxenrollments int               Maximum number of enrollments; valid if LDAP not enabled (default -1)
          --tls.certfile string                       PEM-encoded TLS certificate file for server's listening port (default "tls-cert.pem")
          --tls.clientauth.certfiles stringSlice      A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --tls.clientauth.type string                Policy the server will follow for TLS Client Authentication. (default "noclientcert")
          --tls.enabled                               Enable TLS on the listening port
          --tls.keyfile string                        PEM-encoded TLS key for server's listening port

    Use "fabric-ca-server [command] --help" for more information about a command.

#### 2.客户端命令行。

    Hyperledger Fabric Certificate Authority Client

    Usage:
      fabric-ca-client [command]

    Available Commands:
      affiliation Manage affiliations
      enroll      Enroll an identity
      gencrl      Generate a CRL
      gencsr      Generate a CSR
      getcacert   Get CA certificate chain
      identity    Manage identities
      reenroll    Reenroll an identity
      register    Register an identity
      revoke      Revoke an identity
      version     Prints Fabric CA Client version

    Flags:
          --caname string                  Name of CA
          --csr.cn string                  The common name field of the certificate signing request
          --csr.hosts stringSlice          A list of space-separated host names in a certificate signing request
          --csr.names stringSlice          A list of comma-separated CSR names of the form <name>=<value> (e.g. C=CA,O=Org1)
          --csr.serialnumber string        The serial number in a certificate signing request
      -d, --debug                          Enable debug level logging
          --enrollment.attrs stringSlice   A list of comma-separated attribute requests of the form <name>[:opt] (e.g. foo,bar:opt)
          --enrollment.label string        Label to use in HSM operations
          --enrollment.profile string      Name of the signing profile to use in issuing the certificate
      -H, --home string                    Client's home directory (default "$HOME/.fabric-ca-client")
          --id.affiliation string          The identity's affiliation
          --id.attrs stringSlice           A list of comma-separated attributes of the form <name>=<value> (e.g. foo=foo1,bar=bar1)
          --id.maxenrollments int          The maximum number of times the secret can be reused to enroll (default CA's Max Enrollment)
          --id.name string                 Unique name of the identity
          --id.secret string               The enrollment secret for the identity being registered
          --id.type string                 Type of identity being registered (e.g. 'peer, app, user') (default "client")
      -M, --mspdir string                  Membership Service Provider directory (default "msp")
      -m, --myhost string                  Hostname to include in the certificate signing request during enrollment (default "$HOSTNAME")
      -a, --revoke.aki string              AKI (Authority Key Identifier) of the certificate to be revoked
      -e, --revoke.name string             Identity whose certificates should be revoked
      -r, --revoke.reason string           Reason for revocation
      -s, --revoke.serial string           Serial number of the certificate to be revoked
          --tls.certfiles stringSlice      A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --tls.client.certfile string     PEM-encoded certificate file when mutual authenticate is enabled
          --tls.client.keyfile string      PEM-encoded key file when mutual authentication is enabled
      -u, --url string                     URL of fabric-ca-server (default "http://localhost:7054")

    Use "fabric-ca-client [command] --help" for more information about a command.

请注意，作为字符串切片（列表）的命令行选项可以通过使用以逗号分隔的列表元素指定选项或多次指定选项来指定，每个选项都包含组成列表的字符串值。 例如，要为`csr.hosts`选项指定`host1`和h`ost2`，可以传递`--csr.hosts'host1，host2'`或`--csr.hosts host1 --csr.hosts host2`。 使用以前的格式时，请确保在逗号前后没有空格。

### 六.配置设置

Fabric CA提供3种方法来配置Fabric CA服务器和客户端的设置。 优先顺序是：

* CLI 标志
* 环境变量
* 配置文件

在本文档的其余部分中，我们指的是对配置文件进行更改。 但是，可以通过环境变量或CLI标志覆盖配置文件更改。

例如，如果我们在客户端配置文件中具有以下内容：

    tls:
      # Enable TLS (default: false)
      enabled: false

      # TLS for the client's listenting port (default: false)
      certfiles:
      client:
        certfile: cert.pem
        keyfile:

以下环境变量可用于覆盖配置文件中的`cert.pem`设置：

    export FABRIC_CA_CLIENT_TLS_CLIENT_CERTFILE=cert2.pem
    
如果我们想覆盖环境变量和配置文件，我们可以使用命令行标志。

    fabric-ca-client enroll --tls.client.certfile cert3.pem
    
同样的方法适用于fabric-ca-server，除了不使用FABIRC_CA_CLIENT作为环境变量的前缀外，还使用FABRIC_CA_SERVER。

#### 文件路径

Fabric CA服务器和客户端配置文件中指定文件名的所有属性都支持相对路径和绝对路径。 相对路径相对于配置文件所在的config目录。 例如，如果config目录是〜/ config，并且tls部分如下所示，则Fabric CA服务器或客户端将在〜/config目录中查找root.pem文件，在〜/config中查找cert.pem文件/certs目录和/abs/ path目录中的key.pem文件

    tls:
      enabled: true
      certfiles:
        - root.pem
      client:
        certfile: certs/cert.pem
        keyfile: /abs/path/key.pem


## 第三节:Fabric CA服务端

本节介绍Fabric CA服务器。

启动之前，您可以初始化Fabric CA服务器。 这会提供了一个机会用于生成可在启动服务器之前进行审查和自定义的默认配置文件。

Fabric CA服务器主目录的确定方式如下：

* 如果设置了-home命令行选项，请使用其值
* 否则，如果设置了FABRIC_CA_SERVER_HOME环境变量，则使用其值
* 否则，如果FABRIC_CA_HOME环境变量已设置，请使用其值
* 否则，如果设置了CA_CFG_PATH环境变量，请使用其值
* 否则，使用当前工作目录

对于此服务器部分的其余部分，我们假设您已将FABRIC_CA_HOME环境变量设置为$HOME/fabric-ca/server。

以下说明假定服务器配置文件存在于服务器的主目录中。

### 一.初始化服务器

初始化Fabric CA服务器的命令如下：

    fabric-ca-server init -b admin:adminpw

禁用LDAP时，需要使用-b（引导程序标识）选项进行初始化。 启动Fabric CA服务器至少需要一个引导程序标识; 这个身份是服务器管理员。

服务器配置文件包含可配置的证书签名请求（CSR）部分。 以下是CSR示例。

    cn: fabric-ca-server
    names:
       - C: US
         ST: "North Carolina"
         L:
         O: Hyperledger
         OU: Fabric
    hosts:
      - host1.example.com
      - localhost
    ca:
       expiry: 131400h
       pathlength: 1

以上所有字段都与由`fabric-ca-server init`生成的X.509签名密钥和证书。 这对应于服务器配置文件中的`ca.certfile`和`ca.keyfile`文件。 这些字段如下所示：

* cn是通用名称
* O是组织的名称
* OU是组织单位
* L是位置或城市
* ST是国家
* C是国家

如果需要CSR的自定义值，则可以自定义配置文件，删除由`ca.certfile`和`ca.keyfil`e配置项指定的文件，然后再次运行`fabric-ca-server init -b admin：adminpw`命令。

除非指定了`-u <parent-fabric-ca-server-URL>`选项，否则`fabric-ca-server init`命令会生成自签名CA证书。 如果指定了-u，则服务器的CA证书由父Fabric CA服务器签署。 为了向父Fabric CA服务器进行身份验证，URL的格式必须为`<scheme>://<enrollmentID>：<secret> @ <host>：<port>`，其中`<enrollmentID>`和`<secret>`对应于 `'hf.IntermediateCA'`属性的值等于`'true'`。 `fabric-ca-server init`命令还会在服务器的主目录中生成一个名为`fabric-ca-server-config.yaml`的默认配置文件。

如果您希望Fabric CA服务器使用您提供的CA签名证书和密钥文件，则必须将文件分别放置在由`ca.certfile`和`ca.keyfile引`用的位置。 两个文件都必须是PEM编码的，并且不得加密。 更具体地说，CA证书文件的内容必须以`----- BEGIN CERTIFICATE -----`开头，并且密钥文件的内容必须以`----- BEGIN PRIVATE KEY -----`开头，而不是 `-----BEGIN ENCRYPTED PRIVATE KEY-----`。

##### 算法和密钥长度

可以定制CSR以生成支持椭圆曲线（ECDSA）的X.509证书和密钥。 以下设置是使用曲线prime256v1和签名算法`ecdsa-with-SHA256`实施椭圆曲线数字签名算法（ECDSA）的一个示例：

    key:
       algo: ecdsa
       size: 256

算法的选择和密钥的长度选择基于安全性的需要

椭圆曲线（ECDSA）提供了下面的密钥长度选择：

| 长度 |	ASN1 OID |  	  签名算法    |
|-----|-----------|-------------------|
| 256 |	prime256v1|	ecdsa-with-SHA256 |
| 384 |	secp384r1 |	ecdsa-with-SHA384 |
| 521 |	secp521r1 |	ecdsa-with-SHA512 |

### 二.启动服务器

启动服务器的命令如下：

    fabric-ca-server start -b <admin>:<adminpw>

如果服务器以前没有被初始化，它将在第一次启动时自行初始化。 在初始化期间，如果服务器尚不存在，服务器将生成`ca-cert.pem`和`ca-key.pem`文件，并且如果该文件不存在，还会创建一个默认配置文件。 

除非Fabric CA服务器配置为使用LDAP，否则必须至少配置一个预先注册的引导程序标识，以便您注册和注册其他标识。 -b选项指定引导标识的名称和密码。

要使Fabric CA服务器在https而不是http上进行侦听，请将`tls.enabled`设置为`true`。

要限制相同密码可用于注册的次数，请将配置文件中的`registry.maxenrollments`设置为适当的值。 如果将值设置为1，则Fabric CA服务器允许密码仅针对特定注册ID使用一次。 如果将该值设置为-1，Fabric CA服务器不会限制密钥可以重新用于注册的次数。 默认值是-1。 将该值设置为0，Fabric CA服务器将禁止所有身份的注册，并且不允许注册身份。

Fabric CA服务监听的端口是7054。

如果您不想将Fabric CA服务器配置为在集群中运行或使用LDAP，则可以跳到结构CA客户端部分。

### 三.配置数据库

本节介绍如何配置Fabric CA服务器以连接PostgreSQL或MySQL数据库。默认数据库是SQLite，Fabric CA服务器主目录中的默认数据库文件是fabric-ca-server.db。

如果您不关心在群集中运行Fabric CA服务器，则可以跳过本节; 否则，您必须按照下面所述配置PostgreSQL或MySQL。 Fabric CA在集群设置中支持以下数据库版本：

* PostgreSQL: 9.5.5或者更高
* MySQL: 5.7或者更高

#### 1.PostgreSQL

The following sample may be added to the server’s configuration file in order to connect to a PostgreSQL database. Be sure to customize the various values appropriately. There are limitations on what characters are allowed in the database name. Please refer to the following Postgres documentation for more information: https://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS



以下示例可能会添加到服务器的配置文件中，以便连接到PostgreSQL数据库。 一定要适当地自定义各种值。 数据库名称中允许使用哪些字符有限制。 有关更多信息，请参阅以下Postgres文档：

https://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS

    db:
      type: postgres
      datasource: host=localhost port=5432 user=Username password=Password dbname=fabric_ca sslmode=verify-full

指定sslmode配置SSL身份验证的类型。 sslmode的有效值为：

|    模式   |                     描述                     |
|----------|----------------------------------------------|
|   禁用	  |  非SSL                                       |                                        
|   要求	  |  始终SSL（跳过验证）                           |
|  认证-ca  |  始终SSL（验证服务器提供的证书是否由受信任的CA签名） |
|  验证全   |  始终SSL（验证服务器提供的证书是否由受信任的CA签名） |   
|  服务器   |  主机名与证书中的主机名相匹配                     |

如果您想使用TLS，则必须指定Fabric CA服务器配置文件中的`db.tls`部分。 如果在`PostgreSQL`服务器上启用了SSL客户端身份验证，则还必须在`db.tls.client`部分中指定客户端证书和密钥文件。 以下是`db.tls`部分的示例：

    db:
      ...
      tls:
          enabled: true
          certfiles:
            - db-server-cert.pem
          client:
                certfile: db-client-cert.pem
                keyfile: db-client-key.pem


certfiles-PEM编码的可信根证书文件列表。
certfile和密钥文件-结构CA服务器用于与PostgreSQL服务器安全通信的PEM编码证书和密钥文件

#### 2.PostgreSQL SSL配置

##### 在PostgreSQL服务器上配置SSL的基本说明：

在postgresql.conf中，取消注释SSL并设置为“on”（SSL = on）
将证书和密钥文件放在PostgreSQL数据目录中。

有关生成自签名证书的说明：https://www.postgresql.org/docs/9.5/static/ssl-tcp.html

注意：自签名证书仅用于测试目的，不应在生产环境中使用

##### PostgreSQL服务器-需要客户端证书

* 将您信任的证书颁发机构（CA）的证书放入PostgreSQL数据目录中的文件root.crt中
* 在postgresql.conf中，将“ssl_ca_file”设置为指向客户端的根证书（CA cert）
* 在pg_hba.conf中的相应hostssl行上将clientcert参数设置为1。

有关在PostgreSQL服务器上配置SSL的更多详细信息，请参阅以下PostgreSQL文档：https://www.postgresql.org/docs/9.4/static/libpq-ssl.html

#### 2.Mysql

以下示例可能会添加到结构CA服务器配置文件中，以便连接到MySQL数据库。 一定要适当地自定义各种值。 数据库名称中允许使用哪些字符有限制。 有关更多信息，请参阅以下MySQL文档：https：//dev.mysql.com/doc/refman/5.7/en/identifiers.html

在MySQL 5.7.X中，某些模式会影响服务器是否允许“0000-00-00”作为有效日期。 可能需要放松MySQL服务器使用的模式。 我们希望允许服务器能够接受零日期值。

在my.cnf中，找到配置选项sql_mode并删除NO_ZERO_DATE（如果存在）。 进行此更改后重新启动MySQL服务器。

请参阅以下有关不同可用模式的MySQL文档，并为正在使用的特定版本的MySQL选择适当的设置。

https://dev.mysql.com/doc/refman/5.7/en/sql-mode.html

    db:
      type: mysql
      datasource: root:rootpw@tcp(localhost:3306)/fabric_ca?parseTime=true&tls=custom

如果通过TLS连接到MySQL服务器，那么也需要`db.tls.client`部分，如上面的PostgreSQL部分所述。

##### MySQL SSL配置

1.打开或创建服务器的my.cnf文件。 在[mysqld]部分添加或取消注释下面的行。 这些应指向服务器的密钥和证书以及根CA证书。

有关创建服务器和客户端认证的说明：http://dev.mysql.com/doc/refman/5.7/en/creating-ssl-files-using-openssl.html

[mysqld] ssl-ca=ca-cert.pem ssl-cert=server-cert.pem ssl-key=server-key.pem

可以运行以下查询以确认SSL已启用。

mysql> SHOW GLOBAL VARIABLES LIKE ‘have_%ssl’;

应该会看到：

| Variable_name |	Value  |
|---------------|----------|
| have_openssl	|   YES    |
| have_ssl	    |   YES    |

2.服务器端SSL配置完成后，下一步是创建一个有权通过SSL访问MySQL服务器的用户。 为此，请登录到MySQL服务器，然后键入：

mysql> GRANT ALL PRIVILEGES ON . TO ‘ssluser’@’%’ IDENTIFIED BY ‘password’ REQUIRE SSL; mysql> FLUSH PRIVILEGES;

如果您想给出用户访问服务器的特定IP地址，请将'％'更改为特定的IP地址。

##### MySQL服务器-需要客户端证书

安全连接的选项与服务器端使用的选项类似。

* ssl-ca标识证书颁发机构（CA）证书。 如果使用此选项，则必须指定服务器使用的相同证书。
* ssl-cert标识MySQL服务器的证书。
* ssl-key标识MySQL服务器的私钥。

假设您要使用无特殊加密要求的帐户进行连接，或者使用包含REQUIRE SSL选项的GRANT语句创建该帐户。 作为一组推荐的安全连接选项，至少使用-ssl-cert和-ssl-key选项启动MySQL服务器。 然后在服务器配置文件中设置db.tls.certfiles属性并启动Fabric CA服务器。

要要求指定客户端证书，请使用REQUIRE X509选项创建帐户。 然后客户端还必须指定适当的客户端密钥和证书文件; 否则，MySQL服务器将拒绝连接。 要为Fabric CA服务器指定客户端密钥和证书文件，请设置db.tls.client.cert文件和db.tls.client.keyfile配置属性。

#### 3.配置LDAP

fabric CA服务器可以配置为从LDAP服务器读取。

特别是，Fabric CA服务器可能会连接到LDAP服务器以执行以下操作：

* 在注册之前验证身份
* 检索用于授权的身份的属性值。

修改Fabric CA服务器的配置文件的LDAP部分，将服务器配置为连接到LDAP服务器。

    ldap:
       # Enables or disables the LDAP client (default: false)
       enabled: false
       # The URL of the LDAP server
       url: <scheme>://<adminDN>:<adminPassword>@<host>:<port>/<base>
       userfilter: <filter>
       attribute:
          # 'names' is an array of strings that identify the specific attributes
          # which are requested from the LDAP server.
          names: <LDAPAttrs>
          # The 'converters' section is used to convert LDAP attribute values
          # to fabric CA attribute values.
          #
          # For example, the following converts an LDAP 'uid' attribute
          # whose value begins with 'revoker' to a fabric CA attribute
          # named "hf.Revoker" with a value of "true" (because the expression
          # evaluates to true).
          #    converters:
          #       - name: hf.Revoker
          #         value: attr("uid") =~ "revoker*"
          #
          # As another example, assume a user has an LDAP attribute named
          # 'member' which has multiple values of "dn1", "dn2", and "dn3".
          # Further assume the following configuration.
          #    converters:
          #       - name: myAttr
          #         value: map(attr("member"),"groups")
          #    maps:
          #       groups:
          #          - name: dn1
          #            value: orderer
          #          - name: dn2
          #            value: peer
          # The value of the user's 'myAttr' attribute is then computed to be
          # "orderer,peer,dn3".  This is because the value of 'attr("member")' is
          # "dn1,dn2,dn3", and the call to 'map' with a 2nd argument of
          # "group" replaces "dn1" with "orderer" and "dn2" with "peer".
          converters:
            - name: <fcaAttrName>
              value: <fcaExpr>
          maps:
            <mapName>:
                - name: <from>
                  value: <to>


* scheme:是ldap或ldaps之一
* adminDN:是管理员用户的专有名称
* pass:管理员用户密码
* host:LDAP服务器的主机的IP地址
* port:是可选的端口号，其中ldap的缺省值为389，ldaps的缺省值为636;
* base:是用于搜索的LDAP树的可选根目录
* filter:是在搜索时将过滤器用于将登录用户名转换为独特名称。 例如：（uid=％s）的值将使用值为登录用户名的uid属性的值来搜索LDAP条目。 同样，（电子邮件=％s）可用于使用电子邮件地址登录。
* LDAPAttrs:是代表用户从LDAP服务器请求的LDAP属性名称数组;
* attribute.converters部分用于将LDAP属性转换为fabric CA属性，其中*fcaAttrName是结构CA属性的名称; *fcaExpr是一个表达式，其评估值被分配给结构CA属性。 例如，假设<LDAPAttrs>是[“uid”]，<fcaAttrName>是'hf.Revoker'，并且<fcaExpr>是'attr（“uid”）=〜“revoker *”'。 这意味着代表用户从LDAP服务器请求名为“uid”的属性。 如果用户'uid'LDAP属性的值以'revoker'开头，那么用户将被赋予'true'值作为'hf.Revoker'属性。 否则，用户被赋予'hf.Revoker'属性的'false'值。
* attribute.maps部分用于映射LDAP响应值。 典型的用例是将与LDAP组关联的独特名称映射到身份类型。

LDAP表达式语言使用https://github.com/Knetic/govaluate/blob/master/MANUAL.md中描述的govaluate包。 这定义了诸如“=〜”之类的运算符和诸如“revoker *”之类的文字，这是一个正则表达式。 扩展基础高级语言的LDAP特定变量和函数如下所示：

* DN:是一个等于用户可分辨名称的变量。
* affiliation:是一个等于用户隶属关系的变量。
* attr:是一个需要1或2个参数的函数。 第一个参数是一个LDAP属性名称。 第二个参数是一个分隔符字符串，用于将多个值连接到单个字符串中; 默认分隔符字符串是“，”。 attr函数总是返回一个'string'类型的值。
* map:是一个需要2个参数的函数。 第一个参数是任何字符串。 第二个参数是一个映射的名字，用来对第一个参数的字符串进行字符串替换。
* if:是一个函数，它需要3个参数，其中第一个参数必须解析为布尔值。 如果它的计算结果为true，则返回第二个参数; 否则，返回第三个参数。

例如：如果用户具有以“O = org1，C = US”结尾的可分辨名称，或者如果用户具有以“org1.dept2”开头的联系并且还具有“admin” 属性为“true”。

##### DN =~ “*O=org1,C=US” || (affiliation =~ “org1.dept2.*” && attr(‘admin’) = ‘true’)

注意：由于attr函数总是返回一个'string'类型的值，所以数字操作符不能用于构造表达式。 例如，以下不是有效的表达式：

    value: attr("gidNumber) >= 10000 && attr("gidNumber) < 10006
    
或者，如下所示的用引号引起来的正则表达式可用于返回等效的结果：

    value: attr("gidNumber") =~ "1000[0-5]$" || attr("mail") == "root@example.com"
    
以下是DockLD镜像位于https://github.com/osixia/docker-openldap的OpenLDAP服务器默认设置的示例配置部分。

    ldap:
       enabled: true
       url: ldap://cn=admin,dc=example,dc=org:admin@localhost:10389/dc=example,dc=org
       userfilter: (uid=%s)

请参阅FABRIC_CA/scripts/run-ldap-tests了解启动OpenLDAP docker镜像，配置它，在FABRIC_CA/cli/server/ldap/ldap_test.go中运行LDAP测试并停止OpenLDAP服务器的脚本。

当配置LDAP时，注册工作如下：

Fabric CA客户端或客户端SDK会发送带有基本授权标头的注册请求。

Fabric CA服务器接收注册请求，解码授权头中的身份名称和密码，使用配置文件中的“userfilter”查找与身份名称关联的DN（Distinquished Name），然后尝试使用LDAP绑定身份的密码。 如果LDAP绑定成功，则注册处理将被授权并可继续。

#### 4.配置集群

您可以使用任何IP sprayer将负载均衡添加到Fabric CA服务器集群。 本节提供了一个如何设置Haproxy以路由到Fabric CA服务器群集的示例。 确保更改主机名和端口以反映Fabric CA Server的设置。

###### haproxy.conf

    global
          maxconn 4096
          daemon

    defaults
          mode http
          maxconn 2000
          timeout connect 5000
          timeout client 50000
          timeout server 50000

    listen http-in
          bind *:7054
          balance roundrobin
          server server1 hostname1:port
          server server2 hostname2:port
          server server3 hostname3:port

注意：如果使用TLS，则需要使用tcp模式。

#### 5.设置多个CA

fabric-ca服务器默认由一个默认的CA组成。 但是，可以使用cafiles或cacount配置选项将其他CA添加到单个服务器。 每个额外的CA将拥有自己的主目录。

##### cacount:

Cacount提供了一种快速启动X个默认额外CA的快速方法。 主目录将相对于服务器目录。 使用此选项，目录结构如下所示：

    --<Server Home>
      |--ca
        |--ca1
        |--ca2

每个额外的CA将在其主目录中获得一个默认配置文件，在配置文件中它将包含一个唯一的CA名称。

例如，以下命令将启动2个默认CA实例：

    fabric-ca-server start -b admin:adminpw --cacount 2

##### cafiles：

如果在使用cafiles配置选项时未提供绝对路径，则CA主目录将相对于服务器目录。

要使用此选项，必须已为每个要启动的CA生成并配置CA配置文件。 每个配置文件必须具有唯一的CA名称和通用名称（CN），否则服务器将无法启动，因为这些名称必须是唯一的。 CA配置文件将覆盖任何默认CA配置，并且CA配置文件中的任何缺失选项将被默认CA的值替换。

优先顺序如下：

1.CA配置文件
2.默认的CA CLI标志
3.默认CA环境变量
4.默认的CA配置文件

CA配置文件必须至少包含以下内容：

    ca:
    # Name of this CA
    name: <CANAME>

    csr:
      cn: <COMMONNAME>

您可以按如下方式配置您的目录结构：

    --<Server Home>
      |--ca
        |--ca1
          |-- fabric-ca-config.yaml
        |--ca2
          |-- fabric-ca-config.yaml
          
例如，以下命令将启动两个自定义的CA实例：

    fabric-ca-server start -b admin:adminpw --cafiles ca/ca1/fabric-ca-config.yaml
    --cafiles ca/ca2/fabric-ca-config.yaml
    
#### 6.注册中间CA    
 
 为了为中间CA创建CA签名证书，中间CA必须按照fabric-ca-client向CA注册的相同方式注册父CA. 这是通过使用-u选项来指定父CA的URL以及注册ID和密码来完成的，如下所示。 与此注册ID关联的身份必须具有名称为“hf.IntermediateCA”和值“true”的属性。 已颁发证书的CN（或通用名称）将被设置为注册ID。 如果中间CA尝试明确指定CN值，则会发生错误。
 
    fabric-ca-server start -b admin:adminpw -u http://<enrollmentID>:<secret>@<parentserver>:<parentport>

 #### 7.升级服务器
 
在升级Fabric CA客户端之前，必须升级Fabric CA服务器。 升级之前，建议备份当前数据库：
 
* 如果使用sqlite3，请备份当前数据库文件（默认情况下命名为fabric-ca-server.db）。
* 对于其他数据库类型，请使用适当的备份/复制机制。
 
要升级Fabric CA服务器的单个实例：
 
1.停止fabric-ca-server进程。
2.确保当前数据库已备份。
3.将之前的fabric-ca-server二进制文件替换为升级版本。
4.启动fabric-ca-server进程。
5.使用以下命令验证fabric-ca-server进程是否可用，其中<host>是启动服务器的主机名：

    fabric-ca-client getcacert -u http://<host>:7054

##### 升级群集：

要使用MySQL或Postgres数据库升级fabric-ca-server实例的集群，请执行以下步骤。 我们假设您正在使用haproxy向host1和host2上的两个fabric-ca-server集群成员（分别在端口7054上侦听）进行负载均衡。完成此过程后，您将对升级的fabric-ca-server集群成员进行负载平衡 在host3和host4上分别监听端口7054。

为了使用haproxy stats监视更改，启用统计信息收集。 将以下行添加到haproxy配置文件的全局部分：

    stats socket /var/run/haproxy.sock mode 666 level operator
    stats timeout 2m
 
重新启动haproxy以获取更改：

    # haproxy -f <configfile> -st $(pgrep haproxy)

要显示haproxy“show stat”命令的摘要信息，以下函数可能对分析返回的大量CSV数据非常有用：
 
    haProxyShowStats() {
       echo "show stat" | nc -U /var/run/haproxy.sock |sed '1s/^# *//'|
          awk -F',' -v fmt="%4s %12s %10s %6s %6s %4s %4s\n" '
             { if (NR==1) for (i=1;i<=NF;i++) f[tolower($i)]=i }
             { printf fmt, $f["sid"],$f["pxname"],$f["svname"],$f["status"],
                           $f["weight"],$f["act"],$f["bck"] }'
    }
 
1.最初，您的haproxy配置文件与以下内容类似：
 
    server server1 host1:7054 check
    server server2 host2:7054 check
 
将此配置更改为以下内容：

    server server1 host1:7054 check backup
    server server2 host2:7054 check backup
    server server3 host3:7054 check
    server server4 host4:7054 check
 
 2.使用新配置重新启动HA代理，如下所示：
 
    haproxy -f <configfile> -st $(pgrep haproxy)

“haProxyShowStats”现在将反映修改的配置，包含两个活动的旧版本备份服务器和两个（尚未启动）升级服务器：

    sid   pxname      svname  status  weig  act  bck
      1   fabric-cas  server3   DOWN     1    1    0
      2   fabric-cas  server4   DOWN     1    1    0
      3   fabric-cas  server1     UP     1    0    1
      4   fabric-cas  server2     UP     1    0    1

3.在host3和host4上安装fabric-ca-server的升级二进制文件。 host3和host4上新升级的服务器应该配置为使用与host1和host2上较旧的服务器相同的数据库。 启动升级后的服务器后，数据库将自动迁移。 haproxy会将所有新流量转发给升级后的服务器，因为它们未配置为备份服务器。 在继续之前，使用“fabric-ca-client getcacert”命令验证群集仍然正常工作。 此外，“haProxyShowStats”现在应该反映所有服务器都处于活动状态，类似于以下内容：
 
    sid   pxname      svname  status  weig  act  bck
      1   fabric-cas  server3    UP     1    1    0
      2   fabric-cas  server4    UP     1    1    0
      3   fabric-cas  server1    UP     1    0    1
      4   fabric-cas  server2    UP     1    0    1

4.停止host1和host2上的旧服务器。 在继续之前，使用“fabric-ca-client getcacert”命令验证您的新群集是否仍然正常工作。 然后从haproxy配置文件中删除旧的服务器备份配置，使其看起来类似于以下内容：

    server server3 host3:7054 check
    server server4 host4:7054 check
 
5.使用新配置重新启动HA代理，如下所示：
 
    haproxy -f <configfile> -st $(pgrep haproxy)

“haProxyShowStats”现在将反映已修改的配置，其中两个已升级到新版本的活动服务器：

    sid   pxname      svname  status  weig  act  bck
      1   fabric-cas  server3   UP       1    1    0
      2   fabric-cas  server4   UP       1    1    0

## 第三节:Fabric CA客户端

本节介绍如何使用fabric-ca-client命令。

Fabric CA客户端的主目录确定如下：

* 如果设置了-home命令行选项，请使用其值
* 否则，如果FABRIC_CA_CLIENT_HOME环境变量已设置，请使用其值
* 否则，如果FABRIC_CA_HOME环境变量已设置，请使用其值
* 否则，如果设置了CA_CFG_PATH环境变量，请使用其值
* 否则，使用$HOME/.fabric-ca-client

以下说明假定客户端配置文件存在于客户端的主目录中。

### 一.注册引导标识

首先，如果需要，请在客户端配置文件中自定义CSR（证书签名请求）部分。 请注意，csr.cn字段必须设置为引导标识的ID。 默认CSR值如下所示：

    csr:
      cn: <<enrollment ID>>
      key:
        algo: ecdsa
        size: 256
      names:
        - C: US
          ST: North Carolina
          L:
          O: Hyperledger Fabric
          OU: Fabric CA
      hosts:
       - <<hostname of the fabric-ca-client>>
      ca:
        pathlen:
        pathlenzero:
        expiry:

Then run fabric-ca-client enroll command to enroll the identity. For example, following command enrolls an identity whose ID is admin and password is adminpw by calling Fabric CA server that is running locally at 7054 port.

然后运行`fabric-ca-client enroll`命令来注册身份。 例如，以下命令通过调用在7054端口本地运行的Fabric CA服务器来登录其标识为admin且密码为adminpw的标识。

    export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin
    fabric-ca-client enroll -u http://admin:adminpw@localhost:7054
    
登记命令在Fabric CA客户端的`msp`目录的子目录中存储注册证书（ECert），相应的私钥和CA证书链PEM文件。 您将看到指示PEM文件存储位置的消息。

### 二.注册一个新的身份

执行注册请求的身份必须是当前登记的，并且已经注册的还必须具有正在注册的身份类型的适当权限。

具体而言，fabric CA服务器在注册期间进行三次授权检查，如下所示：

1.注册服务商（即调用者）必须具有带有逗号分隔值“hf.Registrar.Roles”属性列表，其中一个值等于正在注册的标识类型; 例如，如果注册服务商的“hf.Registrar.Roles”属性值为“peer，app，user”，则注册服务商可以注册peer，app和user类型的身份，但不能注册orderer类型的身份。

2.注册服务商的隶属关系必须等于所注册身份的隶属关系的前缀。 例如，加入“a.b”的注册服务商可以注册“a.b.c”加入者的身份，但不得注册与“a.c”加入者的身份。 如果身份需要根隶属关系，那么联属请求应该是一个点（“.”），并且注册服务商还必须具有根隶属关系。 如果在注册申请中未指定从属关系，则注册的身份将被赋予注册商的隶属关系。

3.如果满足以下所有条件，注册商可以向用户注册属性：

* 只有当注册服务商拥有该属性并且它是hf.Registrar.Attributes属性值的一部分时，注册服务商才能注册具有前缀“hf。”的Fabric CA保留属性。此外，如果属性是类型列表，则被注册的属性的值必须等于或者是注册器具有的值的子集。如果该属性的类型为布尔型，则注册服务商只有在该属性的注册商值为'true'的情况下才能注册该属性。

* 注册自定义属性（即名称不以'hf。'开头的任何属性）要求注册服务器具有“hf.Registar.Attributes”属性，其中注册了属性或模式的值。唯一支持的模式是末尾带有“*”的字符串。例如，“a.b.*”是匹配以“a.b.”开头的所有属性名称的模式。例如，如果注册服务商的hf.Registrar.Attributes = orgAdmin，则注册服务商可以添加或删除身份的唯一属性是'orgAdmin'属性。

* 如果请求的属性名称是'hf.Registrar.Attributes'，则执行额外的检查以查看该属性的请求值是否等于或'hf.Registrar.Attributes'的注册服务商值的子集。为此，每个请求值必须与“hf.Registrar.Attributes”属性的注册商值相匹配。例如，如果'hf.Registrar.Attributes'的注册商值为'ab*，xyz'且所请求的属性值为'abc，xyz'，则它是有效的，因为'abc'与'ab *'匹配并且'xyz'与注册商的'xyz'值相匹配。

#### 例子：
####   有效方案：

1.如果注册服务商具有属性'hf.Registrar.Attributes = a.b.*，x.y.z'并注册属性'a.b.c'，则'a.b.c'与'a.b.*'匹配是有效的。

2.如果注册服务商具有属性'hf.Registrar.Attributes = a.b.*，x.y.z'并且正在注册属性'x.y.z'，则它是有效的，因为'x.y.z'与注册商的'x.y.z'值相匹配。

3.如果注册服务商具有'hf.Registrar.Attributes = ab *，xyz'属性并且请求的属性值为'abc，xyz'，则它是有效的，因为'abc'匹配'ab *'和'xyz' 匹配注册商的“xyz”值。

4.如果注册服务商具有'hf.Registrar.Roles = peer，client'属性并且所请求的属性值是'peer'或'peer，client'，则它是有效的，因为所请求的值等于或是注册商值的子集。

####   无效方案

1.如果注册服务商具有属性'hf.Registrar.Attributes = ab*，xyz'并且正在注册属性'hf.Registar.Attributes = abc，xy*'，则它是无效的，因为所请求的属性'xy*'不是所拥有的模式由注册商提供。值'xy *'是'xyz'的超集。

2.如果注册服务商具有属性'hf.Registrar.Attributes = ab *，xyz'并且正在注册属性'hf.Registar.Attributes = abc，xyz，attr1'，则它是无效的，因为注册商的'hf.Registrar.Attributes'属性值不包含'attr1'。

3.如果注册服务商具有属性'hf.Registrar.Attributes = a.b. *，x.y.z'并注册属性'a.b'，则它是无效的，因为'a.b. *'中不包含值'a.b'。

4.如果注册商具有属性'hf.Registrar.Attributes = a.b. *，x.y.z'并注册属性'x.y'，则它是无效的，因为'x.y'不包含在'x.y.z'中。

5.如果注册服务商具有'hf.Registrar.Roles = peer，client'属性并且请求的属性值为'peer，client，orderer'，则它是无效的，因为注册服务商在hf.Registrar的值中没有订购者角色.Roles属性。

6.如果注册服务商具有'hf.Revoker = false'属性并且所请求的属性值为'true'，则它是无效的，因为hf.Revoker属性是布尔属性，并且该属性的注册商值不是'true'。

下表列出了可以为身份注册的所有属性。属性的名称区分大小写。

|名字	                         |   类型	  |                  描述                                   |
|-----------------------------|----------|--------------------------------------------------------|
|  hf.Registrar.Roles	      |	  List   |           允许注册服务商管理的角色列表                      |
|  hf.Registrar.DelegateRoles |   List   |允许注册服务商向注册服务商提供其hf.Registrar.Roles属性的角色列表|
|  hf.Registrar.Attributes    |   List   |           注册服务商可以注册的属性列表                      |
|          hf.GenCRL          |  Boolean |         如果属性值为true，则Identity可以生成CRL             |
|          hf.Revoker         |	 Boolean |	     如果属性值为真，Identity可以撤销用户和/或证书           |
|        hf.AffiliationMgr    |	 Boolean |       如果属性值为true，则Identity可以管理从属关系           |
|       hf.IntermediateCA     |  Boolean |	     如果属性值为true，身份可以作为中间CA注册               |

注意：注册标识时，可以指定一组属性名称和值。 如果数组指定具有相同名称的多个数组元素，则当前仅使用最后一个元素。 换句话说，目前不支持多值属性。

以下命令使用管理员身份凭证来注册一个新用户，其注册ID为“admin2”，属于“org1.department1”，属性名称为“hf.Revoker”，值为“true”，属性 命名为“admin”，值为“true”。 “：ecert”后缀意味着默认情况下，“admin”属性及其值将被插入到用户的注册证书中，然后可以用它来做出访问控制决定。

    export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin
    fabric-ca-client register --id.name admin2 --id.affiliation org1.department1 --id.attrs 'hf.Revoker=true,admin=true:ecert'
    
密码也被称为登记密码。 该密码需要注册身份。 这允许管理员注册身份并将注册ID和秘密给予别人以注册身份。

可以将多个属性指定为-id.attrs标志的一部分，每个属性必须用逗号分隔。 对于包含逗号的属性值，必须将该属性封装在双引号中。 见下面的例子。

    fabric-ca-client register -d --id.name admin2 --id.affiliation org1.department1 --id.attrs '"hf.Registrar.Roles=peer,user",hf.Revoker=true'

或者

    fabric-ca-client register -d --id.name admin2 --id.affiliation org1.department1 --id.attrs '"hf.Registrar.Roles=peer,user"' --id.attrs hf.Revoker=true

您可以通过编辑客户端的配置文件来为register命令中使用的任何字段设置默认值。 例如，假设配置文件包含以下内容：

    id:
      name:
      type: user
      affiliation: org1.department1
      maxenrollments: -1
      attributes:
        - name: hf.Revoker
          value: true
        - name: anotherAttrName
          value: anotherAttrValue

然后，以下命令将注册一个新的标识，其注册ID为“admin3”，它从命令行获取，剩余部分从配置文件中获取，包括标识类型：“user”，从属关系：“org1.department1” ，以及两个属性：“hf.Revoker”和“anotherAttrName”。

    export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin
    fabric-ca-client register --id.name admin3

要注册具有多个属性的标识，需要在配置文件中指定所有属性名称和值，如上所示。

将maxenrollments设置为0或将其从配置中删除将导致身份被注册为使用CA的最大注册值。 此外，注册身份的最大注册值不能超过CA的最大注册值。 例如，如果CA的最大注册值为5.任何新身份的值必须小于或等于5，也不能将其设置为-1（无限注册）。

接下来，让我们注册一个peer身份，这将用于在以下部分注册peer。 以下命令注册peer1标识。 请注意，我们选择指定我们自己的密码（或秘密），而不是让服务器为我们生成密码。

    export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin
    fabric-ca-client register --id.name peer1 --id.type peer --id.affiliation org1.department1 --id.secret peer1pw

请注意，除非服务器配置文件中指定的非叶隶属关系始终以小写形式存在，否则联属关系区分大小写。 例如，如果服务器配置文件的affiliations部分如下所示：

    affiliations:
      BU1:
        Department1:
          - Team1
      BU2:
        - Department2
        - Department3

BU1，Department1，BU2以小写形式存储。 这是因为Fabric CA使用Viper读取配置。 Viper将映射键视为不区分大小写，并始终返回小写值。 要注册与Team1关联的身份，需要将bu1.department1.Team1指定为-id.affiliation标志，如下所示：

    export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin
    fabric-ca-client register --id.name client1 --id.type client --id.affiliation bu1.department1.Team1

### 三.注册peer身份

现在您已经成功注册了peer身份，现在您可以根据注册ID和密码（即上一部分的密码）注册peer。 这与注册引导程序标识类似，只是我们还演示了如何使用“-M”选项填充Hyperledger Fabric MSP（成员资格服务提供程序）目录结构。

以下命令注册peer1。 确保将“-M”选项的值替换为对等方MSP目录的路径，该目录是对等方的core.yaml文件中的“mspConfigPath”设置。 您还可以将FABRIC_CA_CLIENT_HOME设置为peer主目录。

    export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/peer1
    fabric-ca-client enroll -u http://peer1:peer1pw@localhost:7054 -M $FABRIC_CA_CLIENT_HOME/msp

注册orderer是相同的，但除了MSP目录的路径是orderer的orderer.yaml文件中的'LocalMSPDir'设置。

由fabric-ca-server发布的所有注册证书具有以下组织单位（或简称为“OU”）：

1.OU层次结构的根等于标识类型
2.为身份的隶属关系的每个组件添加一个OU

例如，如果某个标识的类型为peer，且其隶属关系为department1.team1，则标识的OU层次结构（从叶子到根）为OU = team1，OU = department1，OU = peer。

### 四.从另一个Fabric CA服务器获取CA证书链

通常，MSP目录的cacerts目录必须包含其他证书颁发机构的证书颁发机构链，表示peer的所有信任根。

`fabric-ca-client getcacerts`命令用于从其他Fabric CA服务器实例中检索这些证书链。

例如，以下操作将在本地主机上侦听名为“CA2”的端口7055上的第二台Fabric CA服务器。 这表示一个完全独立的信任根，并由区块链上的其他成员管理。

    export FABRIC_CA_SERVER_HOME=$HOME/ca2
    fabric-ca-server start -b admin:ca2pw -p 7055 -n CA2

以下命令将CA2的证书链安装到peer1的MSP目录中。

    export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/peer1
    fabric-ca-client getcacert -u http://localhost:7055 -M $FABRIC_CA_CLIENT_HOME/msp

默认情况下，Fabric CA服务器按照子级优先顺序返回CA链。 这意味着链中的每个CA证书后面都有其颁发者的CA证书。 如果您需要Fabric CA服务器以相反的顺序返回CA链，那么请将环境变量CA_CHAIN_PARENT_FIRST设置为true，然后重新启动Fabric CA服务器。 Fabric CA客户端将适当地处理任一顺序。

### 五.重新登录身份

假设您的注册证书即将到期或已被入侵。 您可以发出reenroll命令来更新您的注册证书，如下所示。

    export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/peer1
    fabric-ca-client reenroll

### 六.撤销证书或身份

身份或证书可以被撤销。 撤销身份将撤销身份所拥有的所有证书，并且还会阻止身份获取任何新证书。 撤销证书将使单个证书无效。

为了撤消证书或身份，主叫身份必须具有hf.Revoker和hf.Registrar.Roles属性。 撤销身份只能撤销证书或身份，其身份与撤消身份的隶属关系相同或前缀相同。 此外，revoker只能撤销在revoker的hf.Registrar.Roles属性中列出的类型的身份。

例如，具有联盟orgs.org1和'hf.Registrar.Roles = peer，client'属性的撤销者可以撤销属于orgs.org1或orgs.org1.department1的同级或客户端类型身份，但不能撤销身份 附属于orgs.org2或任何其他类型。

以下命令将禁用身份并吊销与身份关联的所有证书。 fabric CA服务器从此身份收到的所有未来请求都将被拒绝。

    fabric-ca-client revoke -e <enrollment_id> -r <reason>

以下是可以使用-r标志指定的支持原因：

* 1.unspecified
* 2.keycompromise
* 3.cacompromise
* 4.affiliationchange
* 5.superseded
* 6.cessationofoperation
* 7.certificatehold
* 8.removefromcrl
* 9.privilegewithdrawn
* 10.aacompromise

例如，与联属树的根关联的引导管理员可以撤销peer1的身份，如下所示：

    export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin
    fabric-ca-client revoke -e peer1

通过指定其AKI（授权密钥标识符）和序列号，可以撤销属于某个身份的注册证书，如下所示：

    fabric-ca-client revoke -a xxx -s yyy -r <reason>

例如，您可以使用openssl命令获取AKI和证书的序列号，并将它们传递给revoke命令以撤销所述证书，如下所示：

    serial=$(openssl x509 -in userecert.pem -serial -noout | cut -d "=" -f 2)
    aki=$(openssl x509 -in userecert.pem -text | awk '/keyid/ {gsub(/ *keyid:|:/,"",$1);print tolower($0)}')
    fabric-ca-client revoke -s $serial -a $aki -r affiliationchange
   
-gencrl标志可用于生成包含所有撤销证书的CRL（证书吊销列表）。 例如，以下命令将撤销身份peer1，生成一个CRL并将其存储在<msp文件夹> /crls/crl.pem文件中。

    fabric-ca-client revoke -e peer1 --gencrl

CRL也可以使用gencrl命令生成。

### 七.生成CRL（证书撤销列表）

在Fabric CA服务器中吊销证书后，还必须更新Hyperledger Fabric中的相应MSP。 这包括peers的本地MSP以及相应通道配置块中的MSP。 为此，PEM编码的CRL（证书吊销列表）文件必须放置在MSP的crls文件夹中。 `fabric-ca-client gencrl`命令可用于生成CRL。 任何与hf.GenCRL属性的身份都可以创建一个CRL，其中包含在特定时间段内被吊销的所有证书的序列号。 创建的CRL存储在<msp文件夹> /crls/crl.pem文件中。

以下命令将创建一个包含所有已撤销证书的CRL（过期和未过期），并将CRL存储在〜/msp/crls/crl.pem文件中。

    export FABRIC_CA_CLIENT_HOME=~/clientconfig
    fabric-ca-client gencrl -M ~/msp
    
下一个命令将创建一个CRL，其中包含2017-09-13T16:39:57-08:00（由-revokedafter标志指定）和2017-09-21T16:39之前被撤销的所有证书（过期和未过期） 57-08:00（由-revokedbefore标志指定）并将CRL存储在〜/msp/crls/crl.pem文件中。

    export FABRIC_CA_CLIENT_HOME=~/clientconfig
    fabric-ca-client gencrl --caname "" --revokedafter 2017-09-13T16:39:57-08:00 --revokedbefore 2017-09-21T16:39:57-08:00 -M ~/msp

-caname标志指定发送此请求的CA的名称。 在这个例子中，gencrl请求被发送到默认的CA.

-revokedafter和-revokedbefore标志指定时间段的下限和上限。 生成的CRL将包含在此期间被吊销的证书。 这些值必须是RFC3339格式中指定的UTC时间戳。 时间戳后面的-revoked不能大于时间戳前的-revoked。

默认情况下，CRL的“下次更新”日期设置为第二天。 crl.expiry CA配置属性可用于指定自定义值。

gencrl命令还将接受-expire after和-expire before标志，这些标志可用于生成带有在这些标志指定的时间段内过期的撤销证书的CRL。 例如，以下命令将生成一个CRL，其中包含在2017-09-13T16:39:57-08:00之后和2017-09-21T16:39:57-08:00之前撤销的证书，并且该证书在 2017-09-13T16:39:57-08:00以及2018-09-13T16:39:57-08:00之前

    export FABRIC_CA_CLIENT_HOME=~/clientconfig
    fabric-ca-client gencrl --caname "" --expireafter 2017-09-13T16:39:57-08:00 --expirebefore 2018-09-13T16:39:57-08:00  --revokedafter 2017-09-13T16:39:57-08:00 --revokedbefore 2017-09-21T16:39:57-08:00 -M ~/msp

fabric-samples/fabric-ca示例演示如何生成包含已撤销用户证书的CRL并更新通道msp。 然后它将演示使用撤销的用户凭据查询频道将导致授权错误。

### 八.启用TLS

本节更详细地介绍如何为Fabric CA客户端配置TLS。

以下部分可以在fabric-ca-client-config.yaml中配置。

    tls:
      # Enable TLS (default: false)
      enabled: true
      certfiles:
        - root.pem
      client:
        certfile: tls_client-cert.pem
        keyfile: tls_client-key.pem

certfiles选项是客户端信任的一组根证书。 这通常只是在ca-cert.pem文件中的服务器主目录中找到的根结构CA服务器的证书。

只有在服务器上配置了相互TLS时，才需要客户端选项。

### 九.基于属性的访问控制

访问控制决策可以通过chaincode（以及Hyperledger Fabric运行时）根据身份的属性进行。 这被称为基于属性的访问控制（简称ABAC）。

为了实现这一点，身份的注册证书（ECert）可能包含一个或多个属性名称和值。 链码然后提取属性的值以作出访问控制决定。

例如，假设您正在开发应用程序app1，并希望特定的链式代码操作只能由app1管理员访问。 您的chaincode可以验证调用者的证书（由信任的CA颁发的证书）包含名为app1Admin的值为true的属性。 当然，属性的名称可以是任何值，而且值不一定是布尔值。

那么如何获得具有属性的注册证书？ 有两种方法：

1.当您注册身份时，您可以指定为身份颁发的注册证书在默认情况下应包含一个属性。 此行为可以在注册时被覆盖，但这对于建立默认行为很有用，假设注册发生在您的应用程序之外，不需要任何应用程序更改。

以下显示了如何使用两个属性注册user1：app1Admin和电子邮件。 默认情况下，当用户在注册时没有明确请求属性时，“：ecert”后缀会导致appAdmin属性默认插入到user1的注册证书中。 默认情况下，电子邮件属性未添加到注册证书中。

    fabric-ca-client register --id.name user1 --id.secret user1pw --id.type user --id.affiliation org1 --id.attrs 'app1Admin=true:ecert,email=user1@gmail.com'

2.当您注册身份时，您可能会明确要求将一个或多个属性添加到证书中。 对于每个请求的属性，您可以指定该属性是否可选。 如果没有选择请求并且身份不具有该属性，则会发生错误。

以下显示了如何使用电子邮件属性注册user1，而不使用app1Admin属性，以及可选的电话属性（如果用户拥有电话属性）。

    fabric-ca-client enroll -u http://user1:user1pw@localhost:7054 --enrollment.attrs "email,phone:opt"

下表显示了为每个身份自动注册的三个属性。

|          属性名字     |       	属性值        |
|---------------------|------------------------|
|   hf.EnrollmentID   |	     身份的注册ID        |
|      hf.Type	      |      身份的类型          |
|   hf.Affiliation    |	     身份的隶属关系      | 

要将任何上述属性默认添加到证书中，您必须使用“：ecert”规范显式注册该属性。 例如，如果注册时没有请求特定属性，则以下注册标识'user1'，以便'hf.Affiliation'属性将被添加到注册证书中。 请注意，隶属关系（即'org1'）的值在'-id.affiliation'和'-id.attrs'标志中必须相同。

    fabric-ca-client register --id.name user1 --id.secret user1pw --id.type user --id.affiliation org1 --id.attrs 'hf.Affiliation=org1:ecert'

有关基于属性的访问控制的chaincode库API的信息，请参阅https://github.com/hyperledger/fabric/tree/release/core/chaincode/lib/cid/README.md

有关演示基于属性的访问控制等的端到端示例，请参阅
https://github.com/hyperledger/fabric-samples/tree/release/fabric-ca/README.md

### 十.动态服务器配置更新

本节介绍如何使用fabric-ca-client在不重新启动服务器的情况下动态更新fabric-ca-server配置的各个部分。

本节中的所有命令都要求您首先通过执行fabric-ca-client注册命令来注册。

#### 1.动态更新身份

本部分介绍如何使用fabric-ca-client动态更新标识。

如果客户身份不满足以下所有条件，则会发生授权失败：

客户端标识必须具有“hf.Registrar.Roles”属性，并使用逗号分隔的值列表，其中一个值等于正在更新的标识类型; 例如，如果客户的身份具有“client，peer”值的“hf.Registrar.Roles”属性，则客户可以更新“client”和“peer”类型的身份，而不是'orderer'。

客户身份的归属必须等于或是更新身份的隶属关系的前缀。 例如，加入“a.b”的客户可以更新“a.b.c”所属的身份，但不能更新“a.c”所属的身份。 如果身份需要根隶属关系，则更新请求应为该关联指定一个点（“.”），并且客户端还必须具有根隶属关系。

以下显示如何添加，修改和删除联盟。

##### 获取身份信息

只要呼叫者符合上述部分中强调的授权要求，呼叫者就可以从fabric-ca服务器检索有关身份的信息。 以下命令显示如何获取身份。

    fabric-ca-client identity list --id user1

呼叫者也可以通过发出以下命令来请求检索其被授权查看的所有身份的信息。

    fabric-ca-client identity list

##### 添加身份

以下内容为'user1'添加了新的标识。 添加一个新身份执行与通过“fabric-ca-client register”命令注册身份相同的操作。 有两种可用于添加新身份的方法。 第一种方法是通过-json标志在JSON字符串中描述标识。

    fabric-ca-client identity add user1 --json '{"secret": "user1pw", "type": "user", "affiliation": "org1", "max_enrollments": 1, "attrs": [{"name": "hf.Revoker", "value": "true"}]}'

以下添加了具有根隶属关系的用户。 请注意，联盟名称“.”表示根隶属关系。

    fabric-ca-client identity add user1 --json '{"secret": "user1pw", "type": "user", "affiliation": ".", "max_enrollments": 1, "attrs": [{"name": "hf.Revoker", "value": "true"}]}'

第二种添加身份的方法是使用直接标志。 请参阅下面的示例以添加'user1'。

    fabric-ca-client identity add user1 --secret user1pw --type user --affiliation . --maxenrollments 1 --attrs hf.Revoker=true

下表列出了身份的所有字段以及它们是必需的还是可选的以及它们可能具有的任何默认值。

|    字段	        |   必要	  |   默认值   |
|----------------|-----------|------------|
|          ID    |    Yes	 |            |
|       Secret   |    No     |	          |
|   Affiliation  |	  No	 | 呼叫者的隶属 |
|        Type	 |    No	 |   客户端    |
|  Maxenrollments|	  No	 |     0      |
|    Attributes  |	  No	 |            |

##### 修改身份

有两种可用于修改现有标识的方法。 第一种方法是通过-json标志来描述对JSON字符串中标识的修改。 可以在一个请求中进行多项修改。 任何未修改的身份元素都将保留其原始值。

注意：“-2”的最大注册值指定要使用CA的最大注册设置。

下面的命令使用-json标志对身份进行多重修改。

    fabric-ca-client identity modify user1 --json '{"secret": "newPassword", "affiliation": ".", "attrs": [{"name": "hf.Regisrar.Roles", "value": "peer,client"},{"name": "hf.Revoker", "value": "true"}]}'

以下命令使用直接标志进行修改。 以下内容将身份“user1”的注册密码（或密码）更新为“新密码”。

    fabric-ca-client identity modify user1 --secret newsecret

以下更新身份'user1'到'org2'的联盟。

    fabric-ca-client identity modify user1 --affiliation org2

以下将身份“user1”的类型更新为“peer”。

    fabric-ca-client identity modify user1 --type peer
    
以下内容将身份“user1”的maxenrollments更新为5。

    fabric-ca-client identity modify user1 --maxenrollments 5

通过指定最大注册值为'-2'，以下内容会导致标识'user1'使用CA的最大注册设置。

    fabric-ca-client identity modify user1 --maxenrollments -2

以下内容将身份“user1”的“hf.Revoker”属性的值设置为“false”。 如果身份具有其他属性，则不会更改。 如果身份以前没有拥有'hf.Revoker'属性，则该属性将添加到身份。 通过为属性指定没有值也可以删除一个属性。

    fabric-ca-client identity modify user1 --attrs hf.Revoker=false

以下内容将删除用户'user1'的'hf.Revoker'属性。

    fabric-ca-client identity modify user1 --attrs hf.Revoker=

以下说明可以在单个fabric-ca-client身份修改命令中使用多个选项。 在这种情况下，秘密和类型都会针对用户'user1'进行更新。

    fabric-ca-client identity modify user1 --secret newpass --type peer

##### 删除身份

以下内容将删除标识“user1”，并撤消与“user1”标识关联的所有证书。

    fabric-ca-client identity remove user1

注意：默认情况下，在fabric-ca-server中禁用身份验证，但可以通过使用-cfg.identities.allowremove选项启动fabric-ca-server来启用身份验证。

#### 2.动态更新从属关系

本节介绍如何使用fabric-ca-client动态更新从属关系。 以下显示如何添加，修改，删除和列出隶属关系。

##### 添加隶属关系

如果客户身份不满足以下所有条件，则会发生授权失败：

* 客户身份的属性'hf.AffiliationMgr'必须具有值'true'。
* 客户身份的隶属关系必须高于所更新的隶属关系。 例如，如果客户的隶属关系是“a.b”，则客户可以添加从属关系“a.b.c”而不是“a”或“a.b”。

以下添加名为'org1.dept1'的新隶属关系。

    fabric-ca-client affiliation add org1.dept1

##### 修改从属关系

如果客户身份不满足以下所有条件，则会发生授权失败：

* 客户身份必须具有属性'hf.AffiliationMgr'，其值为'true'。
* 客户身份的隶属关系必须高于所更新的隶属关系。 例如，如果客户的隶属关系是“a.b”，则客户可以添加从属关系“a.b.c”而不是“a”或“a.b”。
* 如果'-force'选项为真，并且存在必须修改的身份，则还必须授权客户端身份修改身份。

以下将'org2'从属关系重新命名为'org3'。 它还重命名任何子隶属关系（例如'org2.department1'重命名为'org3.department1'）。

    fabric-ca-client affiliation modify org2 --name org3

如果存在受隶属关系重命名影响的身份，将导致错误，除非使用了“-force”选项。 使用'-force'选项将更新受影响的身份的隶属关系以使用新隶属关系名称。

    fabric-ca-client affiliation modify org1 --name org2 --force

##### 删除隶属关系

如果客户身份不满足以下所有条件，则会发生授权失败：

* 客户身份必须具有属性'hf.AffiliationMgr'，其值为'true'。
* 客户身份的隶属关系必须高于所更新的隶属关系。 例如，如果客户的隶属关系是“a.b”，则客户可以删除从属关系“a.b.c”而不是“a”或“a.b”。
* 如果'-force'选项为真，并且存在必须修改的身份，则还必须授权客户端身份修改身份。

以下消除了从属关系'org2'以及任何附属关系。 例如，如果'org2.dept1'是'org2'下的隶属，它也会被删除。

    fabric-ca-client affiliation remove org2

如果存在受删除隶属关系影响的身份，除非使用“-force”选项，否则将导致错误。 使用'-force'选项还将删除与该联属关联的所有身份以及与这些身份相关联的证书。

注意：默认情况下，在fabric-ca-server中禁用删除隶属，但可以通过使用-cfg.affiliations.allowremove选项启动fabric-ca-server来启用删除隶属。

##### 列出隶属关系

如果客户身份不满足以下所有条件，则会发生授权失败：
    
* 客户身份必须具有属性'hf.AffiliationMgr'，其值为'true'。
* 客户身份的联属关系必须等于或高于所更新的联属关系。 例如，如果客户的隶属关系是“a.b”，则客户可以获得关于“a.b”或“a.b.c”但不是“a”或“a.c”的关联信息。

以下命令显示如何获得特定的隶属关系。

    fabric-ca-client affiliation list --affiliation org2.dept1

主叫方也可以通过发出以下命令请求获取其有权查看的所有关联信息。

    fabric-ca-client affiliation list

### 十一.联系特定的CA实例

当服务器运行多个CA实例时，请求可以被定向到特定的CA. 默认情况下，如果客户端请求中未指定CA名称，请求将被定向到fabric-ca服务器上的默认CA. 可以在客户端命令的命令行上指定CA名称，如下所示：

    fabric-ca-client enroll -u http://admin:adminpw@localhost:7054 --caname <caname>

## 第四节.HSM

默认情况下，结构CA服务器和客户端将私钥存储在PEM编码文件中，但也可以将它们配置为通过PKCS11 API将私钥存储在HSM（硬件安全模块）中。 此行为在服务器或客户端配置文件的BCCSP（BlockChain加密服务提供程序）部分中配置。

### 一.配置Fabric CA服务器以使用softhsm2

本节介绍如何配置Fabric CA服务器或客户端以使用名为softhsm的PKCS11软件版本（请参阅https://github.com/opendnssec/SoftHSMv2）。

在安装softhsm之后，创建一个令牌，将其标记为“ForFabric”，将该引脚设置为“98765432”。

您可以同时使用配置文件和环境变量来配置BCCSP。例如，按如下方式设置Fabric CA服务器配置文件的bccsp部分。 请注意，默认字段的值是PKCS11。

    #############################################################################
    # BCCSP (BlockChain Crypto Service Provider) section is used to select which
    # crypto library implementation to use
    #############################################################################
    bccsp:
      default: PKCS11
      pkcs11:
        Library: /usr/local/Cellar/softhsm/2.1.0/lib/softhsm/libsofthsm2.so
        Pin: 98765432
        Label: ForFabric
        hash: SHA2
        security: 256
        filekeystore:
          # The directory used for the software file-based keystore
          keystore: msp/keystore
           
你可以通过如下的环境变量来覆盖相关的字段：

    FABRIC_CA_SERVER_BCCSP_DEFAULT=PKCS11  
    FABRIC_CA_SERVER_BCCSP_PKCS11_LIBRARY=/usr/local/Cellar/softhsm/2.1.0/lib/softhsm/libsofthsm2.so 
    FABRIC_CA_SERVER_BCCSP_PKCS11_PIN=98765432 FABRIC_CA_SERVER_BCCSP_PKCS11_LABEL=ForFabric
          
## 第五节.文件格式

### 一.fabric CA服务器的配置文件格式

    #############################################################################
    #   This is a configuration file for the fabric-ca-server command.
    #
    #   COMMAND LINE ARGUMENTS AND ENVIRONMENT VARIABLES
    #   ------------------------------------------------
    #   Each configuration element can be overridden via command line
    #   arguments or environment variables.  The precedence for determining
    #   the value of each element is as follows:
    #   1) command line argument
    #      Examples:
    #      a) --port 443
    #         To set the listening port
    #      b) --ca.keyfile ../mykey.pem
    #         To set the "keyfile" element in the "ca" section below;
    #         note the '.' separator character.
    #   2) environment variable
    #      Examples:
    #      a) FABRIC_CA_SERVER_PORT=443
    #         To set the listening port
    #      b) FABRIC_CA_SERVER_CA_KEYFILE="../mykey.pem"
    #         To set the "keyfile" element in the "ca" section below;
    #         note the '_' separator character.
    #   3) configuration file
    #   4) default value (if there is one)
    #      All default values are shown beside each element below.
    #
    #   FILE NAME ELEMENTS
    #   ------------------
    #   The value of all fields whose name ends with "file" or "files" are
    #   name or names of other files.
    #   For example, see "tls.certfile" and "tls.clientauth.certfiles".
    #   The value of each of these fields can be a simple filename, a
    #   relative path, or an absolute path.  If the value is not an
    #   absolute path, it is interpretted as being relative to the location
    #   of this configuration file.
    #
    #############################################################################

    # Version of config file
    version: <<<VERSION>>>

    # Server's listening port (default: 7054)
    port: 7054

    # Enables debug logging (default: false)
    debug: false

    # Size limit of an acceptable CRL in bytes (default: 512000)
    crlsizelimit: 512000

    #############################################################################
    #  TLS section for the server's listening port
    #
    #  The following types are supported for client authentication: NoClientCert,
    #  RequestClientCert, RequireAnyClientCert, VerifyClientCertIfGiven,
    #  and RequireAndVerifyClientCert.
    #
    #  Certfiles is a list of root certificate authorities that the server uses
    #  when verifying client certificates.
    #############################################################################
    tls:
      # Enable TLS (default: false)
      enabled: false
      # TLS for the server's listening port
      certfile:
      keyfile:
      clientauth:
        type: noclientcert
        certfiles:

    #############################################################################
    #  The CA section contains information related to the Certificate Authority
    #  including the name of the CA, which should be unique for all members
    #  of a blockchain network.  It also includes the key and certificate files
    #  used when issuing enrollment certificates (ECerts) and transaction
    #  certificates (TCerts).
    #  The chainfile (if it exists) contains the certificate chain which
    #  should be trusted for this CA, where the 1st in the chain is always the
    #  root CA certificate.
    #############################################################################
    ca:
      # Name of this CA
      name:
      # Key file (is only used to import a private key into BCCSP)
      keyfile:
      # Certificate file (default: ca-cert.pem)
      certfile:
      # Chain file
      chainfile:

    #############################################################################
    #  The gencrl REST endpoint is used to generate a CRL that contains revoked
    #  certificates. This section contains configuration options that are used
    #  during gencrl request processing.
    #############################################################################
    crl:
      # Specifies expiration for the generated CRL. The number of hours
      # specified by this property is added to the UTC time, the resulting time
      # is used to set the 'Next Update' date of the CRL.
      expiry: 24h

    #############################################################################
    #  The registry section controls how the fabric-ca-server does two things:
    #  1) authenticates enrollment requests which contain a username and password
    #     (also known as an enrollment ID and secret).
    #  2) once authenticated, retrieves the identity's attribute names and
    #     values which the fabric-ca-server optionally puts into TCerts
    #     which it issues for transacting on the Hyperledger Fabric blockchain.
    #     These attributes are useful for making access control decisions in
    #     chaincode.
    #  There are two main configuration options:
    #  1) The fabric-ca-server is the registry.
    #     This is true if "ldap.enabled" in the ldap section below is false.
    #  2) An LDAP server is the registry, in which case the fabric-ca-server
    #     calls the LDAP server to perform these tasks.
    #     This is true if "ldap.enabled" in the ldap section below is true,
    #     which means this "registry" section is ignored.
    #############################################################################
    registry:
      # Maximum number of times a password/secret can be reused for enrollment
      # (default: -1, which means there is no limit)
      maxenrollments: -1

      # Contains identity information which is used when LDAP is disabled
      identities:
         - name: <<<adminUserName>>>
           pass: <<<adminPassword>>>
           type: client
           affiliation: ""
           attrs:
              hf.Registrar.Roles: "peer,orderer,client,user"
              hf.Registrar.DelegateRoles: "peer,orderer,client,user"
              hf.Revoker: true
              hf.IntermediateCA: true
              hf.GenCRL: true
              hf.Registrar.Attributes: "*"
              hf.AffiliationMgr: true

    #############################################################################
    #  Database section
    #  Supported types are: "sqlite3", "postgres", and "mysql".
    #  The datasource value depends on the type.
    #  If the type is "sqlite3", the datasource value is a file name to use
    #  as the database store.  Since "sqlite3" is an embedded database, it
    #  may not be used if you want to run the fabric-ca-server in a cluster.
    #  To run the fabric-ca-server in a cluster, you must choose "postgres"
    #  or "mysql".
    #############################################################################
    db:
      type: sqlite3
      datasource: fabric-ca-server.db
      tls:
          enabled: false
          certfiles:
          client:
            certfile:
            keyfile:

    #############################################################################
    #  LDAP section
    #  If LDAP is enabled, the fabric-ca-server calls LDAP to:
    #  1) authenticate enrollment ID and secret (i.e. username and password)
    #     for enrollment requests;
    #  2) To retrieve identity attributes
    #############################################################################
    ldap:
       # Enables or disables the LDAP client (default: false)
       # If this is set to true, the "registry" section is ignored.
       enabled: false
       # The URL of the LDAP server
       url: ldap://<adminDN>:<adminPassword>@<host>:<port>/<base>
       # TLS configuration for the client connection to the LDAP server
       tls:
          certfiles:
          client:
             certfile:
             keyfile:
       # Attribute related configuration for mapping from LDAP entries to Fabric CA attributes
       attribute:
          # 'names' is an array of strings containing the LDAP attribute names which are
          # requested from the LDAP server for an LDAP identity's entry
          names: ['uid','member']
          # The 'converters' section is used to convert an LDAP entry to the value of
          # a fabric CA attribute.
          # For example, the following converts an LDAP 'uid' attribute
          # whose value begins with 'revoker' to a fabric CA attribute
          # named "hf.Revoker" with a value of "true" (because the boolean expression
          # evaluates to true).
          #    converters:
          #       - name: hf.Revoker
          #         value: attr("uid") =~ "revoker*"
          converters:
             - name:
               value:
          # The 'maps' section contains named maps which may be referenced by the 'map'
          # function in the 'converters' section to map LDAP responses to arbitrary values.
          # For example, assume a user has an LDAP attribute named 'member' which has multiple
          # values which are each a distinguished name (i.e. a DN). For simplicity, assume the
          # values of the 'member' attribute are 'dn1', 'dn2', and 'dn3'.
          # Further assume the following configuration.
          #    converters:
          #       - name: hf.Registrar.Roles
          #         value: map(attr("member"),"groups")
          #    maps:
          #       groups:
          #          - name: dn1
          #            value: peer
          #          - name: dn2
          #            value: client
          # The value of the user's 'hf.Registrar.Roles' attribute is then computed to be
          # "peer,client,dn3".  This is because the value of 'attr("member")' is
          # "dn1,dn2,dn3", and the call to 'map' with a 2nd argument of
          # "group" replaces "dn1" with "peer" and "dn2" with "client".
          maps:
             groups:
                - name:
                  value:

    #############################################################################
    # Affiliations section. Fabric CA server can be bootstrapped with the
    # affiliations specified in this section. Affiliations are specified as maps.
    # For example:
    #   businessunit1:
    #     department1:
    #       - team1
    #   businessunit2:
    #     - department2
    #     - department3
    #
    # Affiliations are hierarchical in nature. In the above example,
    # department1 (used as businessunit1.department1) is the child of businessunit1.
    # team1 (used as businessunit1.department1.team1) is the child of department1.
    # department2 (used as businessunit2.department2) and department3 (businessunit2.department3)
    # are children of businessunit2.
    # Note: Affiliations are case sensitive except for the non-leaf affiliations
    # (like businessunit1, department1, businessunit2) that are specified in the configuration file,
    # which are always stored in lower case.
    #############################################################################
    affiliations:
       org1:
          - department1
          - department2
       org2:
          - department1

    #############################################################################
    #  Signing section
    #
    #  The "default" subsection is used to sign enrollment certificates;
    #  the default expiration ("expiry" field) is "8760h", which is 1 year in hours.
    #
    #  The "ca" profile subsection is used to sign intermediate CA certificates;
    #  the default expiration ("expiry" field) is "43800h" which is 5 years in hours.
    #  Note that "isca" is true, meaning that it issues a CA certificate.
    #  A maxpathlen of 0 means that the intermediate CA cannot issue other
    #  intermediate CA certificates, though it can still issue end entity certificates.
    #  (See RFC 5280, section 4.2.1.9)
    #
    #  The "tls" profile subsection is used to sign TLS certificate requests;
    #  the default expiration ("expiry" field) is "8760h", which is 1 year in hours.
    #############################################################################
    signing:
        default:
          usage:
            - digital signature
          expiry: 8760h
        profiles:
          ca:
             usage:
               - cert sign
               - crl sign
             expiry: 43800h
             caconstraint:
               isca: true
               maxpathlen: 0
          tls:
             usage:
                - signing
                - key encipherment
                - server auth
                - client auth
                - key agreement
             expiry: 8760h

    ###########################################################################
    #  Certificate Signing Request (CSR) section.
    #  This controls the creation of the root CA certificate.
    #  The expiration for the root CA certificate is configured with the
    #  "ca.expiry" field below, whose default value is "131400h" which is
    #  15 years in hours.
    #  The pathlength field is used to limit CA certificate hierarchy as described
    #  in section 4.2.1.9 of RFC 5280.
    #  Examples:
    #  1) No pathlength value means no limit is requested.
    #  2) pathlength == 1 means a limit of 1 is requested which is the default for
    #     a root CA.  This means the root CA can issue intermediate CA certificates,
    #     but these intermediate CAs may not in turn issue other CA certificates
    #     though they can still issue end entity certificates.
    #  3) pathlength == 0 means a limit of 0 is requested;
    #     this is the default for an intermediate CA, which means it can not issue
    #     CA certificates though it can still issue end entity certificates.
    ###########################################################################
    csr:
       cn: <<<COMMONNAME>>>
       names:
          - C: US
            ST: "North Carolina"
            L:
            O: Hyperledger
            OU: Fabric
       hosts:
         - <<<MYHOST>>>
         - localhost
       ca:
          expiry: 131400h
          pathlength: <<<PATHLENGTH>>>

    #############################################################################
    # BCCSP (BlockChain Crypto Service Provider) section is used to select which
    # crypto library implementation to use
    #############################################################################
    bccsp:
        default: SW
        sw:
            hash: SHA2
            security: 256
            filekeystore:
                # The directory used for the software file-based keystore
                keystore: msp/keystore

    #############################################################################
    # Multi CA section
    #
    # Each Fabric CA server contains one CA by default.  This section is used
    # to configure multiple CAs in a single server.
    #
    # 1) --cacount <number-of-CAs>
    # Automatically generate <number-of-CAs> non-default CAs.  The names of these
    # additional CAs are "ca1", "ca2", ... "caN", where "N" is <number-of-CAs>
    # This is particularly useful in a development environment to quickly set up
    # multiple CAs.
    #
    # 2) --cafiles <CA-config-files>
    # For each CA config file in the list, generate a separate signing CA.  Each CA
    # config file in this list MAY contain all of the same elements as are found in
    # the server config file except port, debug, and tls sections.
    #
    # Examples:
    # fabric-ca-server start -b admin:adminpw --cacount 2
    #
    # fabric-ca-server start -b admin:adminpw --cafiles ca/ca1/fabric-ca-server-config.yaml
    # --cafiles ca/ca2/fabric-ca-server-config.yaml
    #
    #############################################################################

    cacount:

    cafiles:

    #############################################################################
    # Intermediate CA section
    #
    # The relationship between servers and CAs is as follows:
    #   1) A single server process may contain or function as one or more CAs.
    #      This is configured by the "Multi CA section" above.
    #   2) Each CA is either a root CA or an intermediate CA.
    #   3) Each intermediate CA has a parent CA which is either a root CA or another intermediate CA.
    #
    # This section pertains to configuration of #2 and #3.
    # If the "intermediate.parentserver.url" property is set,
    # then this is an intermediate CA with the specified parent
    # CA.
    #
    # parentserver section
    #    url - The URL of the parent server
    #    caname - Name of the CA to enroll within the server
    #
    # enrollment section used to enroll intermediate CA with parent CA
    #    profile - Name of the signing profile to use in issuing the certificate
    #    label - Label to use in HSM operations
    #
    # tls section for secure socket connection
    #   certfiles - PEM-encoded list of trusted root certificate files
    #   client:
    #     certfile - PEM-encoded certificate file for when client authentication
    #     is enabled on server
    #     keyfile - PEM-encoded key file for when client authentication
    #     is enabled on server
    #############################################################################
    intermediate:
      parentserver:
        url:
        caname:

      enrollment:
        hosts:
        profile:
        label:

      tls:
        certfiles:
        client:
          certfile:
          keyfile:


### 二.fabric CA客户端的配置文件格式

    #############################################################################
    #   This is a configuration file for the fabric-ca-client command.
    #
    #   COMMAND LINE ARGUMENTS AND ENVIRONMENT VARIABLES
    #   ------------------------------------------------
    #   Each configuration element can be overridden via command line
    #   arguments or environment variables.  The precedence for determining
    #   the value of each element is as follows:
    #   1) command line argument
    #      Examples:
    #      a) --url https://localhost:7054
    #         To set the fabric-ca server url
    #      b) --tls.client.certfile certfile.pem
    #         To set the client certificate for TLS
    #   2) environment variable
    #      Examples:
    #      a) FABRIC_CA_CLIENT_URL=https://localhost:7054
    #         To set the fabric-ca server url
    #      b) FABRIC_CA_CLIENT_TLS_CLIENT_CERTFILE=certfile.pem
    #         To set the client certificate for TLS
    #   3) configuration file
    #   4) default value (if there is one)
    #      All default values are shown beside each element below.
    #
    #   FILE NAME ELEMENTS
    #   ------------------
    #   The value of all fields whose name ends with "file" or "files" are
    #   name or names of other files.
    #   For example, see "tls.certfiles" and "tls.client.certfile".
    #   The value of each of these fields can be a simple filename, a
    #   relative path, or an absolute path.  If the value is not an
    #   absolute path, it is interpretted as being relative to the location
    #   of this configuration file.
    #
    #############################################################################

    #############################################################################
    # Client Configuration
    #############################################################################

    # URL of the Fabric-ca-server (default: http://localhost:7054)
    url: <<<URL>>>

    # Membership Service Provider (MSP) directory
    # This is useful when the client is used to enroll a peer or orderer, so
    # that the enrollment artifacts are stored in the format expected by MSP.
    mspdir: msp

    #############################################################################
    #    TLS section for secure socket connection
    #
    #  certfiles - PEM-encoded list of trusted root certificate files
    #  client:
    #    certfile - PEM-encoded certificate file for when client authentication
    #    is enabled on server
    #    keyfile - PEM-encoded key file for when client authentication
    #    is enabled on server
    #############################################################################
    tls:
      # TLS section for secure socket connection
      certfiles:
      client:
        certfile:
        keyfile:

    #############################################################################
    #  Certificate Signing Request section for generating the CSR for an
    #  enrollment certificate (ECert)
    #
    #  cn - Used by CAs to determine which domain the certificate is to be generated for
    #
    #  serialnumber - The serialnumber field, if specified, becomes part of the issued
    #     certificate's DN (Distinguished Name).  For example, one use case for this is
    #     a company with its own CA (Certificate Authority) which issues certificates
    #     to its employees and wants to include the employee's serial number in the DN
    #     of its issued certificates.
    #     WARNING: The serialnumber field should not be confused with the certificate's
    #     serial number which is set by the CA but is not a component of the
    #     certificate's DN.
    #
    #  names -  A list of name objects. Each name object should contain at least one
    #    "C", "L", "O", or "ST" value (or any combination of these) where these
    #    are abbreviations for the following:
    #        "C": country
    #        "L": locality or municipality (such as city or town name)
    #        "O": organization
    #        "OU": organizational unit, such as the department responsible for owning the key;
    #         it can also be used for a "Doing Business As" (DBS) name
    #        "ST": the state or province
    #
    #    Note that the "OU" or organizational units of an ECert are always set according
    #    to the values of the identities type and affiliation. OUs are calculated for an enroll
    #    as OU=<type>, OU=<affiliationRoot>, ..., OU=<affiliationLeaf>. For example, an identity
    #    of type "client" with an affiliation of "org1.dept2.team3" would have the following
    #    organizational units: OU=client, OU=org1, OU=dept2, OU=team3
    #
    #  hosts - A list of host names for which the certificate should be valid
    #
    #############################################################################
    csr:
      cn: <<<ENROLLMENT_ID>>>
      serialnumber:
      names:
        - C: US
          ST: North Carolina
          L:
          O: Hyperledger
          OU: Fabric
      hosts:
        - <<<MYHOST>>>

    #############################################################################
    #  Registration section used to register a new identity with fabric-ca server
    #
    #  name - Unique name of the identity
    #  type - Type of identity being registered (e.g. 'peer, app, user')
    #  affiliation - The identity's affiliation
    #  maxenrollments - The maximum number of times the secret can be reused to enroll.
    #                   Specially, -1 means unlimited; 0 means to use CA's max enrollment
    #                   value.
    #  attributes - List of name/value pairs of attribute for identity
    #############################################################################
    id:
      name:
      type:
      affiliation:
      maxenrollments: 0
      attributes:
       # - name:
       #   value:

    #############################################################################
    #  Enrollment section used to enroll an identity with fabric-ca server
    #
    #  profile - Name of the signing profile to use in issuing the certificate
    #  label - Label to use in HSM operations
    #############################################################################
    enrollment:
      profile:
      label:

    #############################################################################
    # Name of the CA to connect to within the fabric-ca server
    #############################################################################
    caname:

    #############################################################################
    # BCCSP (BlockChain Crypto Service Provider) section allows to select which
    # crypto implementation library to use
    #############################################################################
    bccsp:
        default: SW
        sw:
            hash: SHA2
            security: 256
            filekeystore:
                # The directory used for the software file-based keystore
                keystore: msp/keystore

## 第六节.故障排除

1.如果您在尝试执行fabric-ca-client或fabric-ca-server时在OSX上看到Killed：9错误，请在https://github.com/golang/go/issues/19734上描述此问题。 简而言之，要解决此问题，可以运行以下命令：

    # sudo ln -s /usr/bin/true /usr/local/bin/dsymutil

2. 错误`[ERROR] No certificates found for provided serial and aki`将会发生,如果发生以下一系列事件:

* 您发布fabric-ca-client注册命令，创建注册证书（即ECert）。 这将ECert的副本存储在fabric-ca-server的数据库中。
* fabric-ca-server的数据库被删除并重新创建，从而失去了步骤'a'中的ECert。 例如，如果您停止并重新启动托管fabric-ca-server的docker容器，但fabric-ca-server正在使用缺省的sqlite数据库，并且该数据库文件未存储在卷上并因此不持久。
* 您发出一个fabric-ca-client注册命令或任何其他尝试使用步骤'a'中的ECert的命令。 在这种情况下，由于数据库不再包含ECert，`[ERROR] No certificates found for provided serial and aki`将会发生。

要解决此错误，您必须重复步骤“a”重新注册。 这将发布一个新的ECert，它将被存储在当前数据库中。

3.将多个并行请求发送到使用共享sqlite3数据库的Fabric CA Server集群时，服务器偶尔会返回“数据库锁定”错误。 这很可能是因为数据库事务在等待数据库锁定（由另一个集群成员持有）被释放时超时。 这是一个无效的配置，因为sqlite是一个嵌入式数据库，这意味着Fabric CA服务器群集必须通过共享文件系统共享相同的文件，这会引入SPoF（单点故障），这与集群拓扑的目的相矛盾。 最佳做法是在集群拓扑中使用Postgres或MySQL数据库。





