# 第三章：HyperLedger证书认证服务

本章的内容的构建来自“主”分支

Hyperledger fabric CA是Hyperledger fabric的认证中心（CA）。

它提供了以下功能：

* 注册身份，或者连接到LDAP作为用户注册表
* 发放登记证书（ECerts）
* 证书更新和撤销

Hyperledger fabric CA由服务器和客户端组件组成。

如果您兴趣参与Hyperledger Fabric CA的开发人员，请参阅Fabric CA存储库以获取更多信息。

## 第一节.概述

下图说明了Hyperledger Fabric CA服务器如何适用于整体Hyperledger Fabric架构。

图片1： 
    ![图片1](https://github.com/guoshijiang/Hyperledger_fabric_v1.0/blob/master/img/1.png "图片1")

有两种与Hyperledger Fabric CA服务器进行交互的方式：通过Hyperledger Fabric CA客户端或通过某个Fabric SDK进行交互。 与Hyperledger Fabric CA服务器的所有通信均通过REST API提供。 有关这些REST API的swagger文档，请参阅fabric-ca/swagger/swagger-fabric-ca.json。

Hyperledger Fabric CA客户端或SDK可能连接到Hyperledger Fabric CA服务器群集中的服务器。 这在图的右上部分中说明。 客户端路由到HA代理端点，该端点将流量负载平衡到fabric-ca-server集群成员之一。

群集中的所有Hyperledger Fabric CA服务器都共享相同的数据库以跟踪身份和证书。 如果配置了LDAP，则身份信息将保存在LDAP中而不是数据库中。

一台服务器可能包含多个CA。 每个CA都是根CA或中间CA. 每个中间CA都有一个父CA，它是根CA或另一个中间CA.

## 第二节.Hyperledger fabric CA入门

### 一.使用的必要条件

* 安装go 1.9+ 
* 设置正确的GOPATH环境变量
* 安装libtool和libtdhl-dev软件包

以下内容是在Ubuntu上安装libtool依赖项：

    sudo apt install libtool libltdl-dev

以下内容是在MacOSX上安装libtool依赖项：

    brew install libtool

注意：如果您通过Homebrew安装libtool，则libtldl-dev在MacOSX上不是必需的

有关libtool的更多信息，请点击：https://www.gnu.org/software/libtool。

有关libltdl-dev的更多信息，请点击：https://www.gnu.org/software/libtool/manual/html_node/Using-libltdl.html。

### 二.安装

以下安装将会在$GOPATH/bin中安装fabric-ca-server和fabric-ca-client的二进制文件。

    go get -u github.com/hyperledger/fabric-ca/cmd/...

注意：如果你已经克隆了fabric-ca代码，请在运行上面的“go get”命令之前确保您位于master分支上。 否则，您可能会看到以下错误：

        <gopath>/src/github.com/hyperledger/fabric-ca; git pull --ff-only
        There is no tracking information for the current branch.
        Please specify which branch you want to merge with.
        See git-pull(1) for details.

            git pull <remote> <branch>

        If you wish to set tracking information for this branch you can do so with:

            git branch --set-upstream-to=<remote>/<branch> tlsdoc

        package github.com/hyperledger/fabric-ca/cmd/fabric-ca-client: exit status 1

### 三.本地启动服务器

以下命令以默认设置启动fabric-ca-server。

    fabric-ca-server start -b admin:adminpw

-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。

一个名为fabric-ca-server-config.yaml的默认配置文件将在可以自定义的本地目录中创建。

### 四.通过Docker启动服务

#### 1.Docker Hub

点击这个链接：https://hub.docker.com/r/hyperledger/fabric-ca/tags/ 

找到与您想要提取的fabric-ca的体系结构和版本相匹配的标签。

到这个目录下：$GOPATH/src/github.com/hyperledger/fabric-ca/docker/server并在编辑器中打开docker-compose.yml。

更改镜像行以反映您之前找到的标签。 该文件对于Beta版本的x86体系结构也是这样的。

    fabric-ca-server:
      image: hyperledger/fabric-ca:x86_64-1.0.0-beta
      container_name: fabric-ca-server
      ports:
        - "7054:7054"
      environment:
        - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      volumes:
        - "./fabric-ca-server:/etc/hyperledger/fabric-ca-server"
      command: sh -c 'fabric-ca-server start -b admin:adminpw'

在与docker-compose.yml文件相同的目录中打开终端并执行以下命令：

    # docker-compose up -d

如果尚未存在，则会将组合文件中指定的fabric-ca镜像下拉，然后启动fabric-ca服务器的实例。

#### 2.构建你自己的Docker镜像

您可以通过docker-compose构建并启动服务器，如下所示。

    cd $GOPATH/src/github.com/hyperledger/fabric-ca
    make docker
    cd docker/server
    docker-compose up -d
    
hyperled/fabric-ca docker镜像包含fabric-ca-server和fabric-ca-client。

    # cd $GOPATH/src/github.com/hyperledger/fabric-ca
    # FABRIC_CA_DYNAMIC_LINK=true make docker
    # cd docker/server
    # docker-compose up -d
    
### 五.探索Fabric CA CLI

本节仅为方便起见提供Fabric CA服务器和客户端的使用消息。以下部分提供了其他使用信息。

#### 1.服务器命令行

    Hyperledger Fabric Certificate Authority Server

    Usage:
      fabric-ca-server [command]

    Available Commands:
      init        Initialize the fabric-ca server
      start       Start the fabric-ca server
      version     Prints Fabric CA Server version

    Flags:
          --address string                            Listening address of fabric-ca-server (default "0.0.0.0")
      -b, --boot string                               The user:pass for bootstrap admin which is required to build default config file
          --ca.certfile string                        PEM-encoded CA certificate file (default "ca-cert.pem")
          --ca.chainfile string                       PEM-encoded CA chain file (default "ca-chain.pem")
          --ca.keyfile string                         PEM-encoded CA key file
      -n, --ca.name string                            Certificate Authority name
          --cacount int                               Number of non-default CA instances
          --cafiles stringSlice                       A list of comma-separated CA configuration files
          --cfg.affiliations.allowremove              Enables removal of affiliations dynamically
          --cfg.identities.allowremove                Enables removal of identities dynamically
          --crl.expiry duration                       Expiration for the CRL generated by the gencrl request (default 24h0m0s)
          --crlsizelimit int                          Size limit of an acceptable CRL in bytes (default 512000)
          --csr.cn string                             The common name field of the certificate signing request to a parent fabric-ca-server
          --csr.hosts stringSlice                     A list of space-separated host names in a certificate signing request to a parent fabric-ca-server
          --csr.serialnumber string                   The serial number in a certificate signing request to a parent fabric-ca-server
          --db.datasource string                      Data source which is database specific (default "fabric-ca-server.db")
          --db.tls.certfiles stringSlice              A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --db.tls.client.certfile string             PEM-encoded certificate file when mutual authenticate is enabled
          --db.tls.client.keyfile string              PEM-encoded key file when mutual authentication is enabled
          --db.type string                            Type of database; one of: sqlite3, postgres, mysql (default "sqlite3")
      -d, --debug                                     Enable debug level logging
      -H, --home string                               Server's home directory (default "/etc/hyperledger/fabric-ca")
          --intermediate.enrollment.label string      Label to use in HSM operations
          --intermediate.enrollment.profile string    Name of the signing profile to use in issuing the certificate
          --intermediate.parentserver.caname string   Name of the CA to connect to on fabric-ca-server
      -u, --intermediate.parentserver.url string      URL of the parent fabric-ca-server (e.g. http://<username>:<password>@<address>:<port)
          --intermediate.tls.certfiles stringSlice    A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --intermediate.tls.client.certfile string   PEM-encoded certificate file when mutual authenticate is enabled
          --intermediate.tls.client.keyfile string    PEM-encoded key file when mutual authentication is enabled
          --ldap.attribute.names stringSlice          The names of LDAP attributes to request on an LDAP search
          --ldap.enabled                              Enable the LDAP client for authentication and attributes
          --ldap.groupfilter string                   The LDAP group filter for a single affiliation group (default "(memberUid=%s)")
          --ldap.tls.certfiles stringSlice            A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --ldap.tls.client.certfile string           PEM-encoded certificate file when mutual authenticate is enabled
          --ldap.tls.client.keyfile string            PEM-encoded key file when mutual authentication is enabled
          --ldap.url string                           LDAP client URL of form ldap://adminDN:adminPassword@host[:port]/base
          --ldap.userfilter string                    The LDAP user filter to use when searching for users (default "(uid=%s)")
      -p, --port int                                  Listening port of fabric-ca-server (default 7054)
          --registry.maxenrollments int               Maximum number of enrollments; valid if LDAP not enabled (default -1)
          --tls.certfile string                       PEM-encoded TLS certificate file for server's listening port (default "tls-cert.pem")
          --tls.clientauth.certfiles stringSlice      A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --tls.clientauth.type string                Policy the server will follow for TLS Client Authentication. (default "noclientcert")
          --tls.enabled                               Enable TLS on the listening port
          --tls.keyfile string                        PEM-encoded TLS key for server's listening port

    Use "fabric-ca-server [command] --help" for more information about a command.

#### 2.客户端命令行。

    Hyperledger Fabric Certificate Authority Client

    Usage:
      fabric-ca-client [command]

    Available Commands:
      affiliation Manage affiliations
      enroll      Enroll an identity
      gencrl      Generate a CRL
      gencsr      Generate a CSR
      getcacert   Get CA certificate chain
      identity    Manage identities
      reenroll    Reenroll an identity
      register    Register an identity
      revoke      Revoke an identity
      version     Prints Fabric CA Client version

    Flags:
          --caname string                  Name of CA
          --csr.cn string                  The common name field of the certificate signing request
          --csr.hosts stringSlice          A list of space-separated host names in a certificate signing request
          --csr.names stringSlice          A list of comma-separated CSR names of the form <name>=<value> (e.g. C=CA,O=Org1)
          --csr.serialnumber string        The serial number in a certificate signing request
      -d, --debug                          Enable debug level logging
          --enrollment.attrs stringSlice   A list of comma-separated attribute requests of the form <name>[:opt] (e.g. foo,bar:opt)
          --enrollment.label string        Label to use in HSM operations
          --enrollment.profile string      Name of the signing profile to use in issuing the certificate
      -H, --home string                    Client's home directory (default "$HOME/.fabric-ca-client")
          --id.affiliation string          The identity's affiliation
          --id.attrs stringSlice           A list of comma-separated attributes of the form <name>=<value> (e.g. foo=foo1,bar=bar1)
          --id.maxenrollments int          The maximum number of times the secret can be reused to enroll (default CA's Max Enrollment)
          --id.name string                 Unique name of the identity
          --id.secret string               The enrollment secret for the identity being registered
          --id.type string                 Type of identity being registered (e.g. 'peer, app, user') (default "client")
      -M, --mspdir string                  Membership Service Provider directory (default "msp")
      -m, --myhost string                  Hostname to include in the certificate signing request during enrollment (default "$HOSTNAME")
      -a, --revoke.aki string              AKI (Authority Key Identifier) of the certificate to be revoked
      -e, --revoke.name string             Identity whose certificates should be revoked
      -r, --revoke.reason string           Reason for revocation
      -s, --revoke.serial string           Serial number of the certificate to be revoked
          --tls.certfiles stringSlice      A list of comma-separated PEM-encoded trusted certificate files (e.g. root1.pem,root2.pem)
          --tls.client.certfile string     PEM-encoded certificate file when mutual authenticate is enabled
          --tls.client.keyfile string      PEM-encoded key file when mutual authentication is enabled
      -u, --url string                     URL of fabric-ca-server (default "http://localhost:7054")

    Use "fabric-ca-client [command] --help" for more information about a command.

请注意，作为字符串切片（列表）的命令行选项可以通过使用以逗号分隔的列表元素指定选项或多次指定选项来指定，每个选项都包含组成列表的字符串值。 例如，要为`csr.hosts`选项指定`host1`和h`ost2`，可以传递`--csr.hosts'host1，host2'`或`--csr.hosts host1 --csr.hosts host2`。 使用以前的格式时，请确保在逗号前后没有空格。

### 六.配置设置

Fabric CA提供3种方法来配置Fabric CA服务器和客户端的设置。 优先顺序是：

* CLI 标志
* 环境变量
* 配置文件

在本文档的其余部分中，我们指的是对配置文件进行更改。 但是，可以通过环境变量或CLI标志覆盖配置文件更改。

例如，如果我们在客户端配置文件中具有以下内容：

    tls:
      # Enable TLS (default: false)
      enabled: false

      # TLS for the client's listenting port (default: false)
      certfiles:
      client:
        certfile: cert.pem
        keyfile:

以下环境变量可用于覆盖配置文件中的`cert.pem`设置：

    export FABRIC_CA_CLIENT_TLS_CLIENT_CERTFILE=cert2.pem
    
如果我们想覆盖环境变量和配置文件，我们可以使用命令行标志。

    fabric-ca-client enroll --tls.client.certfile cert3.pem
    
同样的方法适用于fabric-ca-server，除了不使用FABIRC_CA_CLIENT作为环境变量的前缀外，还使用FABRIC_CA_SERVER。

#### 文件路径

Fabric CA服务器和客户端配置文件中指定文件名的所有属性都支持相对路径和绝对路径。 相对路径相对于配置文件所在的config目录。 例如，如果config目录是〜/ config，并且tls部分如下所示，则Fabric CA服务器或客户端将在〜/config目录中查找root.pem文件，在〜/config中查找cert.pem文件/certs目录和/abs/ path目录中的key.pem文件

    tls:
      enabled: true
      certfiles:
        - root.pem
      client:
        certfile: certs/cert.pem
        keyfile: /abs/path/key.pem


## 第三节:Fabric CA服务端

本节介绍Fabric CA服务器。

启动之前，您可以初始化Fabric CA服务器。 这会提供了一个机会用于生成可在启动服务器之前进行审查和自定义的默认配置文件。

Fabric CA服务器主目录的确定方式如下：

* 如果设置了-home命令行选项，请使用其值
* 否则，如果设置了FABRIC_CA_SERVER_HOME环境变量，则使用其值
* 否则，如果FABRIC_CA_HOME环境变量已设置，请使用其值
* 否则，如果设置了CA_CFG_PATH环境变量，请使用其值
* 否则，使用当前工作目录

对于此服务器部分的其余部分，我们假设您已将FABRIC_CA_HOME环境变量设置为$HOME/fabric-ca/server。

以下说明假定服务器配置文件存在于服务器的主目录中。

### 一.初始化服务器

初始化Fabric CA服务器的命令如下：

    fabric-ca-server init -b admin:adminpw

禁用LDAP时，需要使用-b（引导程序标识）选项进行初始化。 启动Fabric CA服务器至少需要一个引导程序标识; 这个身份是服务器管理员。

服务器配置文件包含可配置的证书签名请求（CSR）部分。 以下是CSR示例。

    cn: fabric-ca-server
    names:
       - C: US
         ST: "North Carolina"
         L:
         O: Hyperledger
         OU: Fabric
    hosts:
      - host1.example.com
      - localhost
    ca:
       expiry: 131400h
       pathlength: 1

以上所有字段都与由`fabric-ca-server init`生成的X.509签名密钥和证书。 这对应于服务器配置文件中的`ca.certfile`和`ca.keyfile`文件。 这些字段如下所示：

* cn是通用名称
* O是组织的名称
* OU是组织单位
* L是位置或城市
* ST是国家
* C是国家

如果需要CSR的自定义值，则可以自定义配置文件，删除由`ca.certfile`和`ca.keyfil`e配置项指定的文件，然后再次运行`fabric-ca-server init -b admin：adminpw`命令。

除非指定了`-u <parent-fabric-ca-server-URL>`选项，否则`fabric-ca-server init`命令会生成自签名CA证书。 如果指定了-u，则服务器的CA证书由父Fabric CA服务器签署。 为了向父Fabric CA服务器进行身份验证，URL的格式必须为`<scheme>://<enrollmentID>：<secret> @ <host>：<port>`，其中`<enrollmentID>`和`<secret>`对应于 `'hf.IntermediateCA'`属性的值等于`'true'`。 `fabric-ca-server init`命令还会在服务器的主目录中生成一个名为`fabric-ca-server-config.yaml`的默认配置文件。

如果您希望Fabric CA服务器使用您提供的CA签名证书和密钥文件，则必须将文件分别放置在由`ca.certfile`和`ca.keyfile引`用的位置。 两个文件都必须是PEM编码的，并且不得加密。 更具体地说，CA证书文件的内容必须以`----- BEGIN CERTIFICATE -----`开头，并且密钥文件的内容必须以`----- BEGIN PRIVATE KEY -----`开头，而不是 `-----BEGIN ENCRYPTED PRIVATE KEY-----`。

##### 算法和密钥长度

可以定制CSR以生成支持椭圆曲线（ECDSA）的X.509证书和密钥。 以下设置是使用曲线prime256v1和签名算法`ecdsa-with-SHA256`实施椭圆曲线数字签名算法（ECDSA）的一个示例：

    key:
       algo: ecdsa
       size: 256

算法的选择和密钥的长度选择基于安全性的需要

椭圆曲线（ECDSA）提供了下面的密钥长度选择：

| 长度 |	ASN1 OID |  	  签名算法    |
|-----|-----------|-------------------|
| 256 |	prime256v1|	ecdsa-with-SHA256 |
| 384 |	secp384r1 |	ecdsa-with-SHA384 |
| 521 |	secp521r1 |	ecdsa-with-SHA512 |






































